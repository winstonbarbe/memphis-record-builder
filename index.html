<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memphis Builder</title>
    <link rel="stylesheet" href="main.css" />
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-Q6E0V4YB7B"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-Q6E0V4YB7B");
    </script>

    <script type="text/javascript">
      (function (c, l, a, r, i, t, y) {
        c[a] =
          c[a] ||
          function () {
            (c[a].q = c[a].q || []).push(arguments);
          };

        t = l.createElement(r);
        t.async = 1;
        t.src = "https://www.clarity.ms/tag/" + i;

        y = l.getElementsByTagName(r)[0];
        y.parentNode.insertBefore(t, y);
      })(window, document, "clarity", "script", "ojk647k75k");
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
      jQuery(document).ready(function () {
        jQuery(document).on("click", ".printed-label", function (event) {
          $("#black-white-2").parent().trigger("click");
        });

        /*jQuery(document).on('click', '.record-type-standard-label', function(event) { 
	 jQuery('#short-run-record-type-color-container').addClass('visible');
});*/

        jQuery(document).on("click", ".custom-splatter", function (event) {
          jQuery(this)
            .parent()
            .find(".builder-splatter-color-picker")
            .addClass("visible");
          jQuery(".splater-colors .color-picker-option").css(
            "pointer-events",
            ""
          );
        });

        jQuery(document).on("click", ".custom-color", function (event) {
          jQuery(this)
            .parent()
            .find(".builder-record-color-picker")
            .addClass("visible");
          jQuery(".splater-colors .color-picker-option").css(
            "pointer-events",
            ""
          );
        });

        jQuery(document).on("click", ".custom-swirl", function (event) {
          jQuery(this)
            .parent()
            .find(".builder-swirl-color-picker")
            .addClass("visible");
          jQuery(".splater-colors .color-picker-option").css(
            "pointer-events",
            ""
          );
        });

        jQuery(".splatter-colors .color-picker-option").click(function () {
          var forthItmeSelected = jQuery(this).attr("data-name");
          var recordColorSelected = jQuery(
            ".record-color-option.selected-record-color"
          ).attr("data-name");
          console.log(forthItmeSelected);

          if (jQuery(this).hasClass("selected-effect-color")) {
            jQuery(this).removeClass("selected-effect-color");
            jQuery(this).css("pointer-events", "");
          } else {
            var selectedCount = jQuery(
              ".splatter-colors .color-picker-option.selected-effect-color"
            ).length;

            if (selectedCount < 4) {
              jQuery(this).addClass("selected-effect-color");
              jQuery(this).css("pointer-events", "none");

              if (selectedCount + 1 === 4) {
                setTimeout(function () {
                  jQuery("#black").parent().trigger("click");
                  jQuery("#splatter").parent().removeClass("selected-radio");
                  jQuery("#splatter").parent().trigger("click");
                  jQuery(
                    '.record-color-option[data-name="' +
                      recordColorSelected +
                      '"]'
                  ).trigger("click");
                  jQuery(
                    '.record-color-option[data-name="' +
                      recordColorSelected +
                      '"]'
                  ).addClass("selected-effect-color");
                  jQuery(
                    '.splatter-color-option[data-name="' +
                      forthItmeSelected +
                      '"]'
                  ).trigger("click");
                  jQuery(
                    '.splatter-color-option[data-name="' +
                      forthItmeSelected +
                      '"]'
                  ).addClass("selected-effect-color");
                }, 500);
              }
            } else {
              alert("You can only select up to 3 options.");
            }
          }

          jQuery(".splatter-colors .color-picker-option")
            .not(".selected-effect-color")
            .css("pointer-events", "");
        });

        jQuery(".splater-colors .color-picker-option").click(function () {
          var forthItmeSelected = jQuery(this).attr("data-name");
          var recordColorSelected = jQuery(
            ".record-color-option.selected-record-color"
          ).attr("data-name");
          console.log(forthItmeSelected);

          if (jQuery(this).hasClass("selected-effect-color")) {
            jQuery(this).removeClass("selected-effect-color");
            jQuery(this).css("pointer-events", "");
          } else {
            var selectedCount = jQuery(
              ".splater-colors .color-picker-option.selected-effect-color"
            ).length;

            if (selectedCount < 4) {
              jQuery(this).addClass("selected-effect-color");
              jQuery(this).css("pointer-events", "none");

              if (selectedCount + 1 === 4) {
                setTimeout(function () {
                  jQuery("#black").parent().trigger("click");
                  jQuery("#splatter").parent().removeClass("selected-radio");
                  jQuery("#splatter").parent().trigger("click");
                  jQuery(
                    '.record-color-option[data-name="' +
                      recordColorSelected +
                      '"]'
                  ).trigger("click");
                  jQuery(
                    '.record-color-option[data-name="' +
                      recordColorSelected +
                      '"]'
                  ).addClass("selected-effect-color");
                  jQuery(
                    '.splater-colors .splatter-color-option[data-name="' +
                      forthItmeSelected +
                      '"]'
                  ).trigger("click");
                  jQuery(
                    '.splater-colors .splatter-color-option[data-name="' +
                      forthItmeSelected +
                      '"]'
                  ).addClass("selected-effect-color");
                }, 500);
              }
            } else {
              alert("You can only select up to 3 options.");
            }
          }

          jQuery(".splater-colors .color-picker-option")
            .not(".selected-effect-color")
            .css("pointer-events", "");
        });
      });

      $(document).ready(function () {
        $(".record-color-option").on("click", function () {
          $(".record-color-option").removeClass("selected-effect-color");

          $(this).addClass("selected-effect-color");
        });
      });

      $(document).ready(function () {
        // Array of class selectors to target the containers
        var containers = [
          ".solids-translucent",
          ".solids-opaque",
          ".solid-neon",
          ".smoke-blends",
          ".standard-blends",
          ".deluxe-blends",
          ".metallic-blends",
          ".cream-blends",
        ];

        // Loop through each container and sort the items
        containers.forEach(function (container) {
          var $listContainer = $(container);
          var $items = $listContainer.find(".w-dyn-item");

          $items.sort(function (a, b) {
            var nameA = $(a).find(".memphis-color-option").data("name");
            var nameB = $(b).find(".memphis-color-option").data("name");
            return nameA.localeCompare(nameB);
          });

          $listContainer.append($items); // Append sorted items back to the container
        });
      });

      $(document).on("change", "#upload-center-file", function (e) {
        var file = e.target.files[0];
        if (file) {
          var reader = new FileReader();

          reader.onload = function (event) {
            // Display the image in the builder-record-display div
            $("#builder-record-display").append(
              '<div class="label-upload-display single" style="background-image: url(' +
                event.target.result +
                ');background-size: cover;"><div class="center-label-circle"></div></div>'
            );
          };
          reader.readAsDataURL(file);
          $(".front-upload-display").show();
          $("#upload-center-file-display").text(file.name);
        } else {
          $(".front-upload-display").hide();
          $(".label-upload-display").remove();
          $("#upload-center-file-display").text("");
        }
      });
      $(document).on(
        "click",
        ".front-upload-display .remove-file",
        function () {
          $(".front-upload-display").hide();
          $(".label-upload-display").remove();
        }
      );

      $(document).on(
        "click",
        "form input, form select, form textarea",
        function () {
          $(".visualizer").css("position", "fixed");
        }
      );
    </script>
  </head>
  <body>
    <div id="builder-container">
      <div id="form-column">
        <h1>Memphis Builder</h1>
        <form id="wf-form-Record-Builder-Form">
          <!-- Section 1: Record Details -->
          <div class="form-main-section">
            <h2 class="form-section-title" data-section-number="01">
              RECORD DETAILS
            </h2>

            <!-- Record Cutting -->
            <div class="form-section">
              <label for="record-cutting">Record Cutting</label>
              <select id="record-cutting" name="record-cutting" required>
                <option value="mrp supplied">MRP Supplied</option>
                <option value="customer supplied">Customer Supplied</option>
                <option value="dmm">DMM</option>
              </select>
            </div>

            <!-- Record Size -->
            <div class="form-section">
              <label for="record-size">Record Size</label>
              <select id="record-size" name="record-size" required>
                <option value="12">12 Inch</option>
                <option value="10">10 Inch</option>
                <option value="7">7 Inch</option>
              </select>
            </div>

            <!-- Amount -->
            <div class="form-section">
              <label for="record-amount">Amount</label>
              <select id="record-amount" name="record-amount" required>
                <option value="single">Single</option>
                <option value="double">Double</option>
                <option value="triple">Triple</option>
              </select>
            </div>

            <!-- Record Type -->
            <div class="form-section">
              <label for="record-type">Record Type</label>
              <select id="record-type" name="record-type" required>
                <option value="black">Black</option>
                <option value="solids-translucent">Solids Translucent</option>
                <option value="solids-opaque">Solids Opaque</option>
                <option value="solids-neon">Solids Neon</option>
                <option value="eco-mix" id="eco-mix">Eco Mix</option>
                <option value="standard-blends" id="standard-blends">
                  Standard Blends
                </option>
                <option value="deluxe-blends" id="deluxe-blends">
                  Deluxe Blends
                </option>
                <option value="splatter" id="splatter">Splatter</option>
                <option value="two-color" id="two-color">Two Color</option>
                <option value="picture-disc" id="picture-disc">
                  Picture Disc
                </option>
              </select>
            </div>

            <!-- Record Weight -->
            <div class="form-section">
              <label for="record-weight">Record Weight</label>
              <select id="record-weight" name="record-weight" required>
                <option value="standard">Standard</option>
                <option value="heavyweight" id="heavyweight">
                  Heavyweight
                </option>
              </select>
            </div>

            <!-- Record Color -->
            <div class="form-section record-color-option-container">
              <label>Record Color</label>
              <div id="record-color-button" class="color-button">
                Select Color
              </div>
              <div
                id="selected-record-color-display"
                class="selected-color-display"
              >
                <div
                  id="selected-record-color-swatch"
                  class="selected-color-swatch"
                  style="display: none"
                ></div>
                <div id="selected-record-color-name">No color selected</div>
              </div>
              <input type="hidden" id="record-color" name="record-color" />
              <!-- Old color picker container - hidden, using modal instead -->
              <div
                id="record-color-picker-container"
                class="color-picker-container"
                style="display: none !important"
              >
                <div id="memphis-color-options-container" style="display: none">
                  <div id="ecomix-options-container" style="display: none">
                    <!-- Eco Mix color options -->
                  </div>
                  <div
                    id="soilds-translucent-options-container"
                    style="display: none"
                  >
                    <!-- Solids Translucent color options -->
                  </div>
                  <div
                    id="soilds-opaque-options-container"
                    style="display: none"
                  >
                    <!-- Solids Opaque color options -->
                  </div>
                  <div
                    id="standard-blends-options-container"
                    style="display: none"
                  >
                    <!-- Standard Blends color options -->
                  </div>
                  <div
                    id="deluxe-blends-options-container"
                    style="display: none"
                  >
                    <!-- Deluxe Blends color options -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Picture Disc Upload -->
            <div
              class="form-section"
              id="picture-disc-upload-container"
              style="display: none"
            >
              <label for="picture-disc-upload">Picture Disc Upload</label>
              <input
                type="file"
                id="picture-disc-upload"
                name="picture-disc-upload"
                accept="image/*"
              />
              <div class="file-upload-display" style="display: none">
                <span id="picture-disc-upload-file-display"></span>
                <button type="button" id="remove-picture-disc-image">
                  Remove
                </button>
              </div>
            </div>

            <!-- Splatter Colors -->
            <div class="form-section" id="splatter-options-container">
              <label for="splatter-colors">Number of Splatter Colors</label>
              <select id="splatter-colors" name="splatter-colors">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>

              <div id="splatter-color-one-label" class="splatter-color-label">
                <label>Splatter Color 1</label>
                <div id="splatter-color-one-button" class="color-button">
                  Select Color
                </div>
                <div id="selected-splatter-color-one-name">
                  No color selected
                </div>
                <input
                  type="hidden"
                  id="splatter-color-one"
                  name="splatter-color-one"
                />
                <div
                  id="splatter-picker-color-one-container"
                  class="color-picker-container"
                >
                  <div id="memphis-color-options-container-splatter-one">
                    <div id="soilds-translucent-options-container-splatter-one">
                      <!-- Splatter color options -->
                    </div>
                  </div>
                </div>
              </div>

              <div id="splatter-color-two-label" class="splatter-color-label">
                <label>Splatter Color 2</label>
                <div id="splatter-color-two-button" class="color-button">
                  Select Color
                </div>
                <div id="selected-splatter-color-two-name">
                  No color selected
                </div>
                <input
                  type="hidden"
                  id="splatter-color-two"
                  name="splatter-color-two"
                />
                <div
                  id="splatter-picker-color-two-container"
                  class="color-picker-container"
                >
                  <div id="memphis-color-options-container-splatter-two">
                    <div id="soilds-translucent-options-container-splatter-two">
                      <!-- Splatter color options -->
                    </div>
                  </div>
                </div>
              </div>

              <div id="splatter-color-three-label" class="splatter-color-label">
                <label>Splatter Color 3</label>
                <div id="splatter-color-three-button" class="color-button">
                  Select Color
                </div>
                <div id="selected-splatter-color-three-name">
                  No color selected
                </div>
                <input
                  type="hidden"
                  id="splatter-color-three"
                  name="splatter-color-three"
                />
                <div
                  id="splatter-picker-color-three-container"
                  class="color-picker-container"
                >
                  <div id="memphis-color-options-container-splatter-three">
                    <div
                      id="soilds-translucent-options-container-splatter-three"
                    >
                      <!-- Splatter color options -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Section 2: Packaging -->
          <div class="form-main-section">
            <h2 class="form-section-title" data-section-number="02">
              PACKAGING
            </h2>

            <!-- A. Jacket -->
            <div class="form-subsection">
              <h3 class="form-subsection-title">Jacket</h3>

              <!-- Jacket Type -->
              <div class="form-section">
                <label for="jacket-type">Jacket Type</label>
                <select id="jacket-type" name="jacket-type" required>
                  <option value="single pocket">Single Pocket</option>
                  <option value="wide spine" id="wide-spine">Wide Spine</option>
                  <option value="gatefold" id="gatefold">Gatefold</option>
                  <option value="none">None</option>
                </select>
              </div>

              <!-- Jacket Options -->
              <div class="form-section" id="jacket-options-container">
                <label for="jacket-front-upload">Jacket Front Upload</label>
                <input
                  type="file"
                  id="jacket-front-upload"
                  name="jacket-front-upload"
                  accept="image/*"
                />
                <div class="file-upload-display" style="display: none">
                  <span id="jacket-front-upload-file-display"></span>
                  <button type="button" id="remove-jacket-front-image">
                    Remove
                  </button>
                </div>

                <div>
                  <label for="jacket-color">Jacket Color</label>
                  <select id="jacket-color" name="jacket-color" required>
                    <option value="full color">Full Color</option>
                    <option value="black & white">Black & White</option>
                  </select>
                </div>

                <div id="jacket-finish-options">
                  <label for="jacket-finish">Jacket Finish</label>
                  <select id="jacket-finish" name="jacket-finish" required>
                    <option value="standard gloss">Standard Gloss</option>
                    <option value="matte">Matte</option>
                    <option value="soft touch">Soft Touch</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- B. Label -->
            <div class="form-subsection">
              <h3 class="form-subsection-title">Label</h3>

              <!-- Label Type -->
              <div class="form-section">
                <label for="label-type">Label Type</label>
                <select id="label-type" name="label-type" required>
                  <option value="full color">Full Color</option>
                  <option value="black and white">Black & White</option>
                  <option value="blank">Blank</option>
                </select>
              </div>

              <!-- Label Color (for blank labels) -->
              <div
                class="form-section"
                id="blank-label-options-container"
                style="display: none"
              >
                <label for="label-color">Label Color</label>
                <select id="label-color" name="label-color">
                  <option value="white">White</option>
                  <option value="black">Black</option>
                </select>
              </div>

              <!-- Label Upload -->
              <div class="form-section" id="label-options-container">
                <label for="label-front-upload">Label Front Upload</label>
                <input
                  type="file"
                  id="label-front-upload"
                  name="label-front-upload"
                  accept="image/*"
                />
                <div class="file-upload-display" style="display: none">
                  <span id="label-front-upload-file-display"></span>
                  <button type="button" id="remove-label-front-image">
                    Remove
                  </button>
                </div>
              </div>
            </div>

            <!-- C. Inner Sleeve -->
            <div class="form-subsection">
              <h3 class="form-subsection-title">Inner Sleeve</h3>

              <!-- Inner Sleeve Type -->
              <div class="form-section">
                <label for="sleeve-type">Inner Sleeve Type</label>
                <select id="sleeve-type" name="sleeve-type" required>
                  <option value="anti-static">Anti-Static</option>
                  <option value="paper">Paper</option>
                  <option value="paper w/ poly lining">
                    Paper w/ Poly Lining
                  </option>
                  <option value="printed">Printed</option>
                </select>
              </div>

              <!-- Inner Sleeve Options -->
              <div class="form-section" id="sleeve-options-container">
                <div id="inner-sleeve-upload-container" style="display: none">
                  <label for="sleeve-upload">Inner Sleeve Upload</label>
                  <input
                    type="file"
                    id="sleeve-upload"
                    name="sleeve-upload"
                    accept="image/*"
                  />
                  <div class="file-upload-display" style="display: none">
                    <span id="sleeve-upload-file-display"></span>
                    <button type="button" id="remove-sleeve-image">
                      Remove
                    </button>
                  </div>
                </div>

                <div>
                  <label for="sleeve-color">Inner Sleeve Color</label>
                  <select id="sleeve-color" name="sleeve-color">
                    <option value="white" id="sleeve-white">White</option>
                    <option value="black" id="sleeve-black">Black</option>
                    <option value="black & white" id="sleeve-black-white">
                      Black & White
                    </option>
                    <option value="full color" id="sleeve-full-color">
                      Full Color
                    </option>
                  </select>
                </div>

                <div id="inner-sleeve-finish-options">
                  <label for="sleeve-finish">Inner Sleeve Finish</label>
                  <select id="sleeve-finish" name="sleeve-finish">
                    <option value="standard gloss">Standard Gloss</option>
                    <option value="matte">Matte</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- D. Print Insert -->
            <div class="form-subsection">
              <h3 class="form-subsection-title">Print Insert</h3>

              <!-- Printed Insert Type -->
              <div class="form-section">
                <label for="insert-type">Printed Insert Type</label>
                <select id="insert-type" name="insert-type" required>
                  <option value="none">None</option>
                  <option value="12x12" id="insert-12x12">12x12</option>
                  <option value="24x12" id="insert-24x12">24x12</option>
                  <option value="7x7" id="insert-7x7">7x7</option>
                  <option value="14x7" id="insert-14x7">14x7</option>
                </select>
              </div>

              <!-- Printed Insert Options -->
              <div class="form-section" id="insert-options-container">
                <label for="insert-upload">Printed Insert Upload</label>
                <input
                  type="file"
                  id="insert-upload"
                  name="insert-upload"
                  accept="image/*"
                />
                <div class="file-upload-display" style="display: none">
                  <span id="insert-upload-file-display"></span>
                  <button type="button" id="remove-insert-image">Remove</button>
                </div>

                <div>
                  <label for="insert-sides">Insert Sides</label>
                  <select id="insert-sides" name="insert-sides" required>
                    <option value="one sided">One Sided</option>
                    <option value="two sided">Two Sided</option>
                  </select>
                </div>

                <div>
                  <label for="insert-color">Insert Color</label>
                  <select id="insert-color" name="insert-color" required>
                    <option value="full color">Full Color</option>
                    <option value="black & white">Black & White</option>
                  </select>
                </div>

                <div id="insert-finish-options">
                  <label for="insert-finish">Insert Finish</label>
                  <select id="insert-finish" name="insert-finish" required>
                    <option value="standard gloss">Standard Gloss</option>
                    <option value="matte">Matte</option>
                    <option value="soft touch">Soft Touch</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- E. Download Cards -->
            <div class="form-subsection">
              <h3 class="form-subsection-title">Download Cards</h3>

              <!-- Download Cards Type -->
              <div class="form-section">
                <label for="download-card-type">Download Cards Type</label>
                <select
                  id="download-card-type"
                  name="download-card-type"
                  required
                >
                  <option value="none">None</option>
                  <option value="standard">Standard</option>
                </select>
              </div>
            </div>

            <!-- F. Outer Wrap -->
            <div class="form-subsection">
              <h3 class="form-subsection-title">Outer Wrap</h3>

              <!-- Outer Wrap Type -->
              <div class="form-section">
                <label for="outerwrap-type">Outer Wrap Type</label>
                <select id="outerwrap-type" name="outerwrap-type" required>
                  <option value="polybag">Polybag</option>
                  <option value="shrinkwrap">Shrinkwrap</option>
                  <option value="none">None</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Section 3: Finalize -->
          <div class="form-main-section">
            <h2 class="form-section-title" data-section-number="03">
              FINALIZE
            </h2>

            <!-- Project Name -->
            <div class="form-section">
              <label for="project-name">Project Name</label>
              <input
                type="text"
                name="project-name"
                id="project-name"
                required
                data-display-name="Project Name"
              />
            </div>

            <!-- Full Name -->
            <div class="form-section">
              <label for="full-name">Full Name</label>
              <input
                type="text"
                name="full-name"
                id="full-name"
                required
                data-display-name="Full Name"
              />
            </div>

            <!-- Email -->
            <div class="form-section">
              <label for="email">Email</label>
              <input
                type="email"
                name="email"
                id="email"
                required
                data-display-name="Email"
              />
            </div>
          </div>

          <!-- Quantity (hidden on desktop, shown on mobile) -->
          <div class="form-section desktop-hide-quantity">
            <label for="record-quantity">Quantity</label>
            <select id="record-quantity" name="record-quantity" required>
              <option value="100">100</option>
              <option value="200">200</option>
              <option value="250">250</option>
              <option value="300">300</option>
              <option value="500">500</option>
              <option value="750">750</option>
              <option value="1000">1,000</option>
              <option value="1250">1,250</option>
              <option value="1500">1,500</option>
              <option value="2000">2,000</option>
              <option value="2500">2,500</option>
              <option value="3000">3,000</option>
              <option value="3500">3,500</option>
              <option value="4000">4,000</option>
              <option value="5000">5,000</option>
              <option value="6000">6,000</option>
              <option value="7000">7,000</option>
              <option value="7500">7,500</option>
              <option value="8000">8,000</option>
              <option value="9000">9,000</option>
              <option value="10000">10,000</option>
              <option value="12500">12,500</option>
              <option value="15000">15,000</option>
              <option value="17500">17,500</option>
              <option value="20000">20,000</option>
              <option value="25000">25,000</option>
            </select>
            <div id="min-qty-display">Min: 100</div>
            <div id="max-qty-display">Max: 25,000</div>
          </div>

          <!-- Pricing Display (hidden on desktop, shown on mobile) -->
          <div class="form-section desktop-hide-pricing">
            <div id="slider-total-price-display">$0.00</div>
            <div id="slider-total-price-per-unit">$0.00 per unit</div>
            <button
              type="button"
              id="pricing-breakdown-button"
              class="button-primary"
            >
              View Pricing Breakdown
            </button>
          </div>

          <!-- Mobile Pricing Display (hidden on desktop) -->
          <div
            class="form-section"
            id="mobile-slider-container"
            style="display: none"
          >
            <label for="record-quantity-mobile">Quantity</label>
            <select id="record-quantity-mobile" name="record-quantity-mobile">
              <option value="100">100</option>
              <option value="200">200</option>
              <option value="250">250</option>
              <option value="300">300</option>
              <option value="500">500</option>
              <option value="750">750</option>
              <option value="1000">1,000</option>
              <option value="1250">1,250</option>
              <option value="1500">1,500</option>
              <option value="2000">2,000</option>
              <option value="2500">2,500</option>
              <option value="3000">3,000</option>
              <option value="3500">3,500</option>
              <option value="4000">4,000</option>
              <option value="5000">5,000</option>
              <option value="6000">6,000</option>
              <option value="7000">7,000</option>
              <option value="7500">7,500</option>
              <option value="8000">8,000</option>
              <option value="9000">9,000</option>
              <option value="10000">10,000</option>
              <option value="12500">12,500</option>
              <option value="15000">15,000</option>
              <option value="17500">17,500</option>
              <option value="20000">20,000</option>
              <option value="25000">25,000</option>
            </select>
            <div id="slider-total-price-display-mobile">$0.00</div>
            <div id="slider-total-price-per-unit-mobile">$0.00 per unit</div>
            <button
              type="button"
              id="pricing-breakdown-button-mobile"
              class="button-primary"
            >
              View Pricing Breakdown
            </button>
          </div>

          <!-- Form Verification -->
          <div id="form-verification-success-div" style="display: none">
            <p>All required fields are complete!</p>
          </div>

          <div id="missing-info-container" style="display: none">
            <p>Please complete the following fields:</p>
            <div id="missing-info-display"></div>
          </div>

          <!-- Submit Button -->
          <div class="form-section">
            <button type="button" id="prepare-to-submit" class="button-primary">
              Prepare to Submit
            </button>
          </div>

          <!-- Hidden Price Inputs -->
          <input
            type="hidden"
            id="surcharge-price-input"
            name="surcharge-price-input"
          />
          <input
            type="hidden"
            id="setup-price-input"
            name="setup-price-input"
          />
          <input
            type="hidden"
            id="cutting-price-input"
            name="cutting-price-input"
          />
          <input
            type="hidden"
            id="plating-price-input"
            name="plating-price-input"
          />
          <input
            type="hidden"
            id="stampers-price-input"
            name="stampers-price-input"
          />
          <input
            type="hidden"
            id="test-pressings-price-input"
            name="test-pressings-price-input"
          />
          <input
            type="hidden"
            id="center-label-price-input"
            name="center-label-price-input"
          />
          <input
            type="hidden"
            id="record-price-input"
            name="record-price-input"
          />
          <input
            type="hidden"
            id="inner-sleeve-price-input"
            name="inner-sleeve-price-input"
          />
          <input
            type="hidden"
            id="jacket-price-input"
            name="jacket-price-input"
          />
          <input
            type="hidden"
            id="insert-price-input"
            name="insert-price-input"
          />
          <input
            type="hidden"
            id="download-card-price-input"
            name="download-card-price-input"
          />
          <input
            type="hidden"
            id="outerwrap-price-input"
            name="outerwrap-price-input"
          />
          <input
            type="hidden"
            id="insertion-price-input"
            name="insertion-price-input"
          />
          <input type="hidden" id="misc-price-input" name="misc-price-input" />
          <input
            type="hidden"
            id="total-price-input"
            name="total-price-input"
          />
          <input
            type="hidden"
            id="plating-display-input"
            name="plating-display-input"
          />
          <input
            type="hidden"
            id="test-pressings-shipping-fee-input"
            name="test-pressings-shipping-fee-input"
          />
          <input
            type="hidden"
            id="insertion-of-record-price-input"
            name="insertion-of-record-price-input"
          />
          <input
            type="hidden"
            id="insertion-of-inner-sleeve-price-input"
            name="insertion-of-inner-sleeve-price-input"
          />
          <input
            type="hidden"
            id="insertion-of-printed-insert-price-input"
            name="insertion-of-printed-insert-price-input"
          />
          <input
            type="hidden"
            id="insertion-of-jacket-price-input"
            name="insertion-of-jacket-price-input"
          />
          <input
            type="hidden"
            id="test-pressings-total-price-input"
            name="test-pressings-total-price-input"
          />
        </form>
      </div>

      <div id="visualizer-column">
        <!-- Quantity and Pricing (shown on desktop, hidden on mobile) -->
        <div class="visualizer-quantity-section desktop-show-quantity">
          <label for="record-quantity-visualizer">Quantity</label>
          <select
            id="record-quantity-visualizer"
            name="record-quantity-visualizer"
            required
          >
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="250">250</option>
            <option value="300">300</option>
            <option value="500">500</option>
            <option value="750">750</option>
            <option value="1000">1,000</option>
            <option value="1250">1,250</option>
            <option value="1500">1,500</option>
            <option value="2000">2,000</option>
            <option value="2500">2,500</option>
            <option value="3000">3,000</option>
            <option value="3500">3,500</option>
            <option value="4000">4,000</option>
            <option value="5000">5,000</option>
            <option value="6000">6,000</option>
            <option value="7000">7,000</option>
            <option value="7500">7,500</option>
            <option value="8000">8,000</option>
            <option value="9000">9,000</option>
            <option value="10000">10,000</option>
            <option value="12500">12,500</option>
            <option value="15000">15,000</option>
            <option value="17500">17,500</option>
            <option value="20000">20,000</option>
            <option value="25000">25,000</option>
          </select>
          <div class="qty-display">
            <span>Min: 100</span>
            <span>Max: 25,000</span>
          </div>

          <!-- Pricing Display in Visualizer -->
          <div class="visualizer-pricing-display">
            <div id="slider-total-price-display-visualizer">$0.00</div>
            <div id="slider-total-price-per-unit-visualizer">
              $0.00 per unit
            </div>
            <button
              type="button"
              id="pricing-breakdown-button-visualizer"
              class="button-primary"
            >
              View Pricing Breakdown
            </button>
          </div>
        </div>
        <div id="visualizer">
          <!-- Jacket Cover (Orange Square) -->
          <div
            id="builder-jacket-front-display"
            class="visualizer-jacket-display"
          >
            <img
              id="jacket-image-display"
              style="
                display: none;
                width: 100%;
                height: 100%;
                object-fit: cover;
              "
              alt="Jacket Cover"
            />
          </div>

          <!-- Record Discs Container -->
          <div class="visualizer-records-container">
            <!-- Disc 1 - Keep original ID for builder.js compatibility -->
            <div
              id="builder-record-display"
              class="visualizer-record-display record-disc-1"
            >
              <div class="record-label-center" id="record-label-1"></div>
              <div
                class="record-effect-layer effect-layer-1"
                id="record-effect-layer-1"
              ></div>
              <div
                class="record-effect-layer effect-layer-2"
                id="record-effect-layer-2"
              ></div>
              <div
                class="record-effect-layer effect-layer-3"
                id="record-effect-layer-3"
              ></div>
            </div>
            <div
              id="builder-record-display-2"
              class="visualizer-record-display record-disc-2"
              style="display: none"
            >
              <div class="record-label-center" id="record-label-2"></div>
              <div
                class="record-effect-layer effect-layer-1"
                id="record-effect-layer-1-2"
              ></div>
              <div
                class="record-effect-layer effect-layer-2"
                id="record-effect-layer-2-2"
              ></div>
              <div
                class="record-effect-layer effect-layer-3"
                id="record-effect-layer-3-2"
              ></div>
            </div>
            <div
              id="builder-record-display-3"
              class="visualizer-record-display record-disc-3"
              style="display: none"
            >
              <div class="record-label-center" id="record-label-3"></div>
              <div
                class="record-effect-layer effect-layer-1"
                id="record-effect-layer-1-3"
              ></div>
              <div
                class="record-effect-layer effect-layer-2"
                id="record-effect-layer-2-3"
              ></div>
              <div
                class="record-effect-layer effect-layer-3"
                id="record-effect-layer-3-3"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Color Picker Modal -->
    <div class="modal-background-2" id="color-picker-modal">
      <div class="color-picker-modal-container">
        <button class="close-button" id="color-picker-close-button">×</button>
        <h2 class="color-picker-modal-title">Select Record Color</h2>
        <div class="color-picker-modal-content">
          <div id="color-picker-modal-options-container">
            <div id="ecomix-options-container-modal" style="display: none">
              <!-- Eco Mix color options -->
            </div>
            <div
              id="soilds-translucent-options-container-modal"
              style="display: none"
            >
              <!-- Solids Translucent color options -->
            </div>
            <div
              id="soilds-opaque-options-container-modal"
              style="display: none"
            >
              <!-- Solids Opaque color options -->
            </div>
            <div
              id="standard-blends-options-container-modal"
              style="display: none"
            >
              <!-- Standard Blends color options -->
            </div>
            <div
              id="deluxe-blends-options-container-modal"
              style="display: none"
            >
              <!-- Deluxe Blends color options -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pricing Breakdown Modal -->
    <div class="modal-background-2" id="pricing-breakdown-modal">
      <div class="builder-breakdown-container">
        <button id="close-breakdown-modal" class="close-button">×</button>

        <!-- Price Breakdown Header -->
        <div class="breakdown-header-section">
          <h2 class="breakdown-main-title">Price Breakdown</h2>
          <h3 id="project-title-display" class="breakdown-project-title">
            Project Title
          </h3>
        </div>

        <!-- Mastering Section -->
        <div class="breakdown-section-wrapper" id="mastering-section-wrapper">
          <h4 class="breakdown-section-title">Mastering</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td width="70%" style="text-align: left">
                <span id="mastering-option-display">Audio Pre Flight</span>
              </td>
              <td width="30%" style="text-align: right">
                <span id="mastering-option-sub-price" style="display: none"
                  >$0.00</span
                >
                <span id="mastering-breakdown-display">$0.00</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Set Up Fee Section -->
        <div class="breakdown-section-wrapper" id="setup-section-wrapper">
          <h4 class="breakdown-section-title">Set Up Fee</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td width="70%" style="text-align: left">
                <span id="setup-option-display">Single LP</span>
              </td>
              <td width="30%" style="text-align: right">
                <span id="setup-option-sub-price" style="display: none"
                  >$0.00</span
                >
                <span id="setup-fee-breakdown-display">$0.00</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Cutting Section -->
        <div class="breakdown-section-wrapper" id="cutting-section-wrapper">
          <h4 class="breakdown-section-title">Cutting</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td width="70%" style="text-align: left">
                <span id="cutting-option-display">Standard Cutting</span>
              </td>
              <td width="30%" style="text-align: right">
                <span id="cutting-option-sub-price" style="display: none"
                  >$0.00</span
                >
                <span id="cutting-fee-breakdown-display">$0.00</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Plating Section -->
        <div class="breakdown-section-wrapper" id="plating-section-wrapper">
          <h4 class="breakdown-section-title">Plating</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td width="70%" style="text-align: left">
                <span id="plating-option-display">Standard Plating</span>
              </td>
              <td width="30%" style="text-align: right">
                <span id="plating-option-sub-price" style="display: none"
                  >$0.00</span
                >
                <span id="plating-fee-breakdown-display">$0.00</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Additional Stampers Section -->
        <div class="breakdown-section-wrapper" id="stampers-section-wrapper">
          <h4 class="breakdown-section-title">Additional Stampers</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td width="70%" style="text-align: left">
                <span>0 Additional Stampers</span>
              </td>
              <td width="30%" style="text-align: right">
                <span id="stampers-fee-breakdown-display">$0.00</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Test Pressings Section -->
        <div
          class="breakdown-section-wrapper"
          id="test-pressings-section-wrapper"
        >
          <h4 class="breakdown-section-title">Test Pressings</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td width="70%" style="text-align: left">
                5 Initial Test Pressings
              </td>
              <td width="30%" style="text-align: right">
                <span id="test-pressings-initial-sub-price">$0.00</span>
              </td>
            </tr>
            <tr id="additional-pressings-row" style="display: none">
              <td width="70%" style="text-align: left">
                <span id="num-of-additional-pressings-display">0</span>
                Additional Tests
              </td>
              <td width="30%" style="text-align: right">
                <span id="additional-test-pressings-price-display">$0.00</span>
              </td>
            </tr>
            <tr>
              <td width="70%" style="text-align: left">Shipping Fee</td>
              <td width="30%" style="text-align: right">
                <span id="test-pressings-shipping-sub-price">$0.00</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Center Labels Section -->
        <div
          class="breakdown-section-wrapper"
          id="center-labels-section-wrapper"
        >
          <h4 class="breakdown-section-title">Center Labels</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td width="70%" style="text-align: left">
                <span id="center-labels-option-display">Standard Label</span>
              </td>
              <td width="30%" style="text-align: right">
                <span id="center-labels-option-sub-price" style="display: none"
                  >$0.00</span
                >
                <span id="center-labels-fee-breakdown-display">$0.00</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Records Section -->
        <div class="breakdown-section-wrapper" id="records-section-wrapper">
          <h4 class="breakdown-section-title">Records</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td width="70%" style="text-align: left">
                <span id="record-size-breakdown-display">12 Inch</span>
                <span id="record-weight-breakdown-display">Standard</span>
                <span id="record-type-breakdown-display">Black</span>
              </td>
              <td width="30%" style="text-align: right">
                <span id="records-fee-breakdown-display">$0.00</span>
              </td>
            </tr>
            <tr>
              <td width="70%" style="text-align: left">
                Record Base Color:
                <span id="record-base-color-display">Black</span>
              </td>
            </tr>
            <tr>
              <td width="70%" style="text-align: left">
                Effect Color One: <span id="effect-color-1-display">-</span>
              </td>
            </tr>
            <tr>
              <td width="70%" style="text-align: left">
                Effect Color Two: <span id="effect-color-2-display">-</span>
              </td>
            </tr>
            <tr>
              <td width="70%" style="text-align: left">
                Effect Color Three: <span id="effect-color-3-display">-</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Inner Sleeves Section -->
        <div
          class="breakdown-section-wrapper"
          id="inner-sleeve-section-wrapper"
        >
          <h4 class="breakdown-section-title">Inner Sleeves</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td
                width="70%"
                style="text-align: left; text-transform: capitalize"
              >
                <span id="sleeve-type-breakdown-display">Anti-Static</span>
                <span id="sleeve-color-breakdown-display">White</span>
                <span id="sleeve-finish-breakdown-display">Standard Gloss</span>
              </td>
              <td width="30%" style="text-align: right">
                <span id="inner-sleeve-fee-breakdown-display">$0.00</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Jackets Section -->
        <div class="breakdown-section-wrapper" id="jacket-section-wrapper">
          <h4 class="breakdown-section-title">Jackets</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td width="70%" style="text-align: left">
                <span id="jacket-type-breakdown-display">Single Pocket</span>
                <span id="jacket-color-breakdown-display">Full Color</span>
                <span id="jacket-finish-breakdown-display">Standard Gloss</span>
              </td>
              <td width="30%" style="text-align: right">
                <span id="jacket-fee-breakdown-display">$0.00</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Inserts Section -->
        <div class="breakdown-section-wrapper" id="insert-section-wrapper">
          <h4 class="breakdown-section-title">Inserts</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td
                width="70%"
                style="text-align: left; text-transform: capitalize"
              >
                <span id="insert-type-breakdown-display">None</span>
                <span id="insert-sides-breakdown-display">One Sided</span>
                <span id="insert-color-breakdown-display">Full Color</span>
                <span id="insert-finish-breakdown-display">Standard Gloss</span>
              </td>
              <td width="30%" style="text-align: right">
                <span id="insert-fee-breakdown-display">$0.00</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Outerwrap Section -->
        <div class="breakdown-section-wrapper" id="outerwrap-section-wrapper">
          <h4 class="breakdown-section-title">Outerwrap</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td
                width="70%"
                style="text-align: left; text-transform: capitalize"
              >
                <span id="outerwrap-option-display">None</span>
              </td>
              <td width="30%" style="text-align: right">
                <span id="outerwrap-option-sub-price" style="display: none"
                  >$0.00</span
                >
                <span id="outerwrap-fee-breakdown-display">$0.00</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Download Cards Section -->
        <div
          class="breakdown-section-wrapper"
          id="download-cards-section-wrapper"
        >
          <h4 class="breakdown-section-title">Download Cards</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td
                width="70%"
                style="text-align: left; text-transform: capitalize"
              >
                <span id="download-card-option-display">None</span>
              </td>
              <td width="30%" style="text-align: right">
                <span id="download-card-option-sub-price" style="display: none"
                  >$0.00</span
                >
                <span id="download-cards-fee-breakdown-display">$0.00</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Insertion Fee Section -->
        <div class="breakdown-section-wrapper" id="insertion-section-wrapper">
          <h4 class="breakdown-section-title">Insertion Fee</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td width="70%" style="text-align: left">
                Insertion Fee Total
              </td>
              <td width="30%" style="text-align: right">
                <span id="insertion-fee-breakdown-display">$0.00</span>
              </td>
            </tr>
            <tr>
              <td width="70%" style="text-align: left">
                Insertion of Inner Sleeve
              </td>
              <td width="30%" style="text-align: right">
                <span id="insertion-of-sleeve-price-display">$0.00</span>
              </td>
            </tr>
            <tr>
              <td width="70%" style="text-align: left">
                Insertion of Printed Insert
              </td>
              <td width="30%" style="text-align: right">
                <span id="insertion-of-insert-price-display">$0.00</span>
              </td>
            </tr>
            <tr>
              <td width="70%" style="text-align: left">Insertion of Jacket</td>
              <td width="30%" style="text-align: right">
                <span id="insertion-of-jacket-price-display">$0.00</span>
              </td>
            </tr>
            <tr>
              <td width="70%" style="text-align: left">Insertion of Record</td>
              <td width="30%" style="text-align: right">
                <span id="insertion-of-record-price-display">$0.00</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Misc Charges Section -->
        <div class="breakdown-section-wrapper" id="misc-section-wrapper">
          <h4 class="breakdown-section-title">Misc. Charges</h4>
          <table
            class="breakdown-table"
            width="100%"
            cellpadding="5"
            cellspacing="0"
          >
            <tr>
              <td width="70%" style="text-align: left; display: none"></td>
              <td width="30%" style="text-align: right">
                <span id="misc-fee-breakdown-display">$0.00</span>
              </td>
            </tr>
          </table>
        </div>

        <!-- Total Cost Section -->
        <div class="breakdown-total-section">
          <h2 class="breakdown-total-title">Total Cost</h2>
          <p class="breakdown-total-price" id="order-total-display">$0.00</p>
          <p class="breakdown-total-per-unit" id="order-total-per-unit">
            $0.00/copy
          </p>
        </div>

        <div class="breakdown-action-buttons">
          <button id="continue-editing-button" class="button-primary">
            Continue Editing
          </button>
          <button
            type="submit"
            id="builder-submit-button"
            class="button-primary"
            form="wf-form-Record-Builder-Form"
          >
            Submit Order
          </button>
        </div>
      </div>
    </div>

    <script src="builder.js"></script>
    <script>
      // Sync quantity selects and pricing displays between form and visualizer
      // Use an IIFE to avoid conflicts with builder.js variables
      (function () {
        // Wait for both DOM and builder.js to be ready
        function initAll() {
          const qtyInput = document.getElementById("record-quantity");
          const qtyVisualizer = document.getElementById(
            "record-quantity-visualizer"
          );

          // Pricing display elements
          const priceDisplay = document.getElementById(
            "slider-total-price-display"
          );
          const pricePerUnitDisplay = document.getElementById(
            "slider-total-price-per-unit"
          );
          const priceDisplayVisualizer = document.getElementById(
            "slider-total-price-display-visualizer"
          );
          const pricePerUnitDisplayVisualizer = document.getElementById(
            "slider-total-price-per-unit-visualizer"
          );
          const pricingButton = document.getElementById(
            "pricing-breakdown-button"
          );
          const pricingButtonVisualizer = document.getElementById(
            "pricing-breakdown-button-visualizer"
          );

          // Sync quantity selects
          if (qtyInput && qtyVisualizer) {
            // Sync visualizer -> form
            qtyVisualizer.addEventListener("change", () => {
              qtyInput.value = qtyVisualizer.value;
              qtyInput.dispatchEvent(new Event("change", { bubbles: true }));
              qtyInput.dispatchEvent(new Event("input", { bubbles: true }));
            });

            // Sync form -> visualizer
            qtyInput.addEventListener("change", () => {
              qtyVisualizer.value = qtyInput.value;
            });

            qtyInput.addEventListener("input", () => {
              qtyVisualizer.value = qtyInput.value;
            });
          }

          // Sync pricing displays - update visualizer when form updates
          if (priceDisplay && priceDisplayVisualizer) {
            const observer = new MutationObserver(() => {
              if (priceDisplay.innerText !== priceDisplayVisualizer.innerText) {
                priceDisplayVisualizer.innerText = priceDisplay.innerText;
              }
            });
            observer.observe(priceDisplay, {
              childList: true,
              characterData: true,
              subtree: true,
            });

            // Initial sync
            priceDisplayVisualizer.innerText = priceDisplay.innerText;
          }

          if (pricePerUnitDisplay && pricePerUnitDisplayVisualizer) {
            const observer = new MutationObserver(() => {
              if (
                pricePerUnitDisplay.innerText !==
                pricePerUnitDisplayVisualizer.innerText
              ) {
                pricePerUnitDisplayVisualizer.innerText =
                  pricePerUnitDisplay.innerText;
              }
            });
            observer.observe(pricePerUnitDisplay, {
              childList: true,
              characterData: true,
              subtree: true,
            });

            // Initial sync
            pricePerUnitDisplayVisualizer.innerText =
              pricePerUnitDisplay.innerText;
          }

          // Sync pricing breakdown button clicks
          if (pricingButton && pricingButtonVisualizer) {
            pricingButtonVisualizer.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              pricingButton.click();
            });
          }

          // Ensure pricing breakdown buttons aren't intercepted by color picker handlers
          // Check if any pricing breakdown button clicks are being caught incorrectly
          const pricingBreakdownButtons = [
            document.getElementById("pricing-breakdown-button"),
            document.getElementById("pricing-breakdown-button-visualizer"),
            document.getElementById("pricing-breakdown-button-mobile"),
          ];

          pricingBreakdownButtons.forEach((button) => {
            if (button) {
              // Add a handler in capture phase to ensure it's not being blocked
              // But don't prevent the event - just log for debugging
              button.addEventListener(
                "click",
                (e) => {
                  console.log(
                    "Pricing breakdown button clicked (our handler):",
                    button.id
                  );
                  // Don't prevent or stop - let builder.js handle it
                },
                true // Capture phase - runs before other handlers
              );
            }
          });

          // Control disc visibility based on amount selection
          const amountInput = document.getElementById("record-amount");
          const recordDisc1 = document.getElementById("builder-record-display");
          const recordDisc2 = document.getElementById(
            "builder-record-display-2"
          );
          const recordDisc3 = document.getElementById(
            "builder-record-display-3"
          );

          function updateDiscVisibility() {
            if (!amountInput) return;

            const amount = amountInput.value;

            // Show/hide discs based on selection
            if (recordDisc1) recordDisc1.style.display = "block";
            if (recordDisc2)
              recordDisc2.style.display =
                amount === "double" || amount === "triple" ? "block" : "none";
            if (recordDisc3)
              recordDisc3.style.display =
                amount === "triple" ? "block" : "none";
          }

          // Initial update
          updateDiscVisibility();

          // Update when amount changes
          if (amountInput) {
            amountInput.addEventListener("change", updateDiscVisibility);
          }

          // Sync record images to all visible discs from disc 1 (which builder.js updates)
          // Watch for changes to the original record display (from builder.js)
          if (recordDisc1) {
            const recordObserver = new MutationObserver(() => {
              const bgImage =
                window.getComputedStyle(recordDisc1).backgroundImage;
              if (bgImage && bgImage !== "none" && bgImage !== 'url("")') {
                if (recordDisc2) recordDisc2.style.backgroundImage = bgImage;
                if (recordDisc3) recordDisc3.style.backgroundImage = bgImage;
              }
            });
            recordObserver.observe(recordDisc1, {
              attributes: true,
              attributeFilter: ["style"],
              subtree: true,
            });

            // Also use polling to catch style changes
            let lastRecordImage = "";
            setInterval(() => {
              const currentImage =
                window.getComputedStyle(recordDisc1).backgroundImage;
              if (
                currentImage !== lastRecordImage &&
                currentImage !== "none" &&
                currentImage !== 'url("")'
              ) {
                lastRecordImage = currentImage;
                if (recordDisc2)
                  recordDisc2.style.backgroundImage = currentImage;
                if (recordDisc3)
                  recordDisc3.style.backgroundImage = currentImage;
              }
            }, 100);
          }

          // Handle picture disc upload
          // Wait for DOM to be ready and try multiple times
          function setupPictureDiscHandler() {
            const pictureDiscUpload = document.getElementById(
              "picture-disc-upload"
            );

            if (pictureDiscUpload && recordDisc1) {
              // Add event listener for picture disc upload
              pictureDiscUpload.addEventListener(
                "change",
                (e) => {
                  const file = pictureDiscUpload.files[0];
                  if (file) {
                    const imageUrl = URL.createObjectURL(file);
                    // Apply to all visible discs
                    const discs = [recordDisc1, recordDisc2, recordDisc3];
                    discs.forEach((disc) => {
                      if (disc) {
                        disc.style.backgroundImage = `url(${imageUrl})`;
                        disc.style.backgroundSize = "cover";
                        disc.style.backgroundPosition = "center";
                        disc.style.backgroundRepeat = "no-repeat";
                      }
                    });
                  } else {
                    // Reset to default black record
                    const defaultImage =
                      "url(https://uploads-ssl.webflow.com/65ce69671190e385bf638294/66c35137e88fe82114818e60_Black_Record.png)";
                    const discs = [recordDisc1, recordDisc2, recordDisc3];
                    discs.forEach((disc) => {
                      if (disc) {
                        disc.style.backgroundImage = defaultImage;
                        disc.style.backgroundSize = "contain";
                      }
                    });
                  }
                },
                true
              );
            } else if (!pictureDiscUpload) {
              // Retry if element not found yet
              setTimeout(setupPictureDiscHandler, 100);
            }
          }

          // Set up after DOM is ready
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
              setTimeout(setupPictureDiscHandler, 500);
            });
          } else {
            setTimeout(setupPictureDiscHandler, 500);
          }

          // Handle record type changes to update eco-mix display
          // This needs to access colorsData from the color picker scope
          // We'll set up the handler after colors are loaded
          function setupEcoMixHandler() {
            const recordTypeInput = document.getElementById("record-type");
            const recordColorInput = document.getElementById("record-color");

            if (!recordTypeInput || !recordColorInput) return;

            function updateEcoMixDisplay() {
              const recordType = recordTypeInput.value;
              const colorName = recordColorInput.value;

              // If switching to eco-mix and a color is already selected, update display
              if (recordType === "eco-mix" && colorName) {
                // Try to get colorsData from the color picker scope or reload it
                fetch("./colors.json")
                  .then((response) => response.json())
                  .then((colors) => {
                    const color = colors.find((c) => c.name === colorName);
                    if (color && color.imageUrl) {
                      const recordDiscs = [
                        document.getElementById("builder-record-display"),
                        document.getElementById("builder-record-display-2"),
                        document.getElementById("builder-record-display-3"),
                      ];

                      recordDiscs.forEach((disc) => {
                        if (disc) {
                          disc.style.backgroundImage = `url(${color.imageUrl})`;
                          disc.style.backgroundSize = "cover";
                          disc.style.backgroundPosition = "center";
                          disc.style.backgroundRepeat = "no-repeat";
                        }
                      });
                    }
                  })
                  .catch((error) => {
                    console.error("Error loading colors for eco-mix:", error);
                  });
              }
            }

            // Watch for record type changes
            recordTypeInput.addEventListener("change", () => {
              setTimeout(updateEcoMixDisplay, 100);
            });
          }

          // Set up after DOM is ready
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
              setTimeout(setupEcoMixHandler, 500);
            });
          } else {
            setTimeout(setupEcoMixHandler, 500);
          }

          // Handle label upload to display on record center labels
          const labelUpload = document.querySelector(
            "input[name='label-front-upload']"
          );
          const recordLabel1 = document.getElementById("record-label-1");
          const recordLabel2 = document.getElementById("record-label-2");
          const recordLabel3 = document.getElementById("record-label-3");

          if (labelUpload && recordLabel1) {
            labelUpload.addEventListener(
              "change",
              (e) => {
                const file = labelUpload.files[0];
                if (file) {
                  const imageUrl = URL.createObjectURL(file);

                  // Set label image on all visible discs
                  if (recordLabel1) {
                    recordLabel1.style.backgroundImage = `url(${imageUrl})`;
                    recordLabel1.style.backgroundSize = "cover";
                    recordLabel1.style.backgroundPosition = "center";
                    recordLabel1.style.backgroundRepeat = "no-repeat";
                    recordLabel1.style.opacity = "1";
                  }
                  if (recordLabel2) {
                    recordLabel2.style.backgroundImage = `url(${imageUrl})`;
                    recordLabel2.style.backgroundSize = "cover";
                    recordLabel2.style.backgroundPosition = "center";
                    recordLabel2.style.backgroundRepeat = "no-repeat";
                    recordLabel2.style.opacity = "1";
                  }
                  if (recordLabel3) {
                    recordLabel3.style.backgroundImage = `url(${imageUrl})`;
                    recordLabel3.style.backgroundSize = "cover";
                    recordLabel3.style.backgroundPosition = "center";
                    recordLabel3.style.backgroundRepeat = "no-repeat";
                    recordLabel3.style.opacity = "1";
                  }
                } else {
                  // Clear labels if file removed - make transparent again
                  if (recordLabel1) {
                    recordLabel1.style.backgroundImage = "";
                    recordLabel1.style.opacity = "0";
                  }
                  if (recordLabel2) {
                    recordLabel2.style.backgroundImage = "";
                    recordLabel2.style.opacity = "0";
                  }
                  if (recordLabel3) {
                    recordLabel3.style.backgroundImage = "";
                    recordLabel3.style.opacity = "0";
                  }
                }
              },
              true
            );
          }

          // Ensure jacket image displays properly
          // Handle jacket upload directly to ensure it displays
          const jacketUpload = document.querySelector(
            "input[name='jacket-front-upload']"
          );
          const jacketDisplay = document.getElementById(
            "builder-jacket-front-display"
          );

          if (jacketUpload && jacketDisplay) {
            // Add our own change handler that sets the image
            // Try using img element as fallback
            const jacketImage = document.getElementById("jacket-image-display");

            jacketUpload.addEventListener(
              "change",
              (e) => {
                const file = jacketUpload.files[0];
                if (file) {
                  const imageUrl = URL.createObjectURL(file);

                  // Method 1: Try background-image
                  jacketDisplay.style.setProperty(
                    "background-image",
                    `url(${imageUrl})`,
                    "important"
                  );
                  jacketDisplay.style.setProperty(
                    "background-size",
                    "cover",
                    "important"
                  );
                  jacketDisplay.style.setProperty(
                    "background-position",
                    "center",
                    "important"
                  );
                  jacketDisplay.style.setProperty(
                    "background-repeat",
                    "no-repeat",
                    "important"
                  );
                  jacketDisplay.style.setProperty(
                    "background-color",
                    "transparent",
                    "important"
                  );

                  // Method 2: Also set img element as backup
                  if (jacketImage) {
                    jacketImage.src = imageUrl;
                    jacketImage.style.display = "block";
                  }

                  // Ensure it's visible
                  jacketDisplay.style.display = "block";
                } else {
                  jacketDisplay.style.backgroundImage = "";
                  jacketDisplay.style.backgroundColor = "#fdb813";
                  if (jacketImage) {
                    jacketImage.style.display = "none";
                  }
                }
              },
              true
            ); // Use capture phase

            // Also monitor for changes from builder.js (in case it runs after)
            const jacketObserver = new MutationObserver(() => {
              const bgImage = jacketDisplay.style.backgroundImage;
              if (
                bgImage &&
                bgImage !== "none" &&
                bgImage !== "" &&
                bgImage !== 'url("")'
              ) {
                // Ensure the image is visible with proper styling
                jacketDisplay.style.backgroundImage = bgImage;
                jacketDisplay.style.backgroundSize = "cover";
                jacketDisplay.style.backgroundPosition = "center";
                jacketDisplay.style.backgroundRepeat = "no-repeat";
              }
            });

            jacketObserver.observe(jacketDisplay, {
              attributes: true,
              attributeFilter: ["style"],
              subtree: true,
            });

            // Check on load if there's already an image
            setTimeout(() => {
              const bgImage = jacketDisplay.style.backgroundImage;
              if (
                bgImage &&
                bgImage !== "none" &&
                bgImage !== "" &&
                bgImage !== 'url("")'
              ) {
                jacketDisplay.style.backgroundSize = "cover";
                jacketDisplay.style.backgroundPosition = "center";
                jacketDisplay.style.backgroundRepeat = "no-repeat";
              }
            }, 500);
          } else {
            // Try again after a delay
            setTimeout(initAll, 1000);
          }
        }

        // Try multiple times to ensure elements are found
        if (document.readyState === "loading") {
          window.addEventListener("DOMContentLoaded", initAll);
        } else {
          // DOM already loaded
          setTimeout(initAll, 100);
        }

        // Also try after builder.js has had time to run
        window.addEventListener("load", () => {
          setTimeout(initAll, 500);
        });

        // Immediate attempt
        setTimeout(initAll, 50);
      })();

      // Map builder.js display changes to section wrappers
      (function () {
        // Mapping of display element IDs to their section wrapper IDs
        const sectionMapping = {
          "setup-fee-breakdown-display": "setup-section-wrapper",
          "cutting-fee-breakdown-display": "cutting-section-wrapper",
          "plating-fee-breakdown-display": "plating-section-wrapper",
          "stampers-fee-breakdown-display": "stampers-section-wrapper",
          "mastering-breakdown-display": "mastering-section-wrapper",
          "center-labels-fee-breakdown-display":
            "center-labels-section-wrapper",
          "records-fee-breakdown-display": "records-section-wrapper",
          "inner-sleeve-fee-breakdown-display": "inner-sleeve-section-wrapper",
          "jacket-fee-breakdown-display": "jacket-section-wrapper",
          "insert-fee-breakdown-display": "insert-section-wrapper",
          "outerwrap-fee-breakdown-display": "outerwrap-section-wrapper",
          "download-cards-fee-breakdown-display":
            "download-cards-section-wrapper",
          "misc-fee-breakdown-display": "misc-section-wrapper",
          "insertion-fee-breakdown-display": "insertion-section-wrapper",
        };

        function setupDisplayMapping() {
          Object.keys(sectionMapping).forEach((displayId) => {
            const displayEl = document.getElementById(displayId);
            const sectionWrapper = document.getElementById(
              sectionMapping[displayId]
            );

            if (displayEl && sectionWrapper) {
              // Watch for changes to the display element's parent's style
              const observer = new MutationObserver(() => {
                // Check if the display element's parent is hidden
                const parent = displayEl.parentElement;
                if (parent) {
                  const parentDisplay = window.getComputedStyle(parent).display;
                  if (parentDisplay === "none") {
                    sectionWrapper.style.display = "none";
                  } else if (parentDisplay !== "none" && parentDisplay !== "") {
                    sectionWrapper.style.display = "block";
                  }
                }
              });

              // Watch the parent element for style changes
              const parent = displayEl.parentElement;
              if (parent) {
                observer.observe(parent, {
                  attributes: true,
                  attributeFilter: ["style"],
                  subtree: false,
                });
              }
            }
          });
        }

        // Run after builder.js has loaded
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", () => {
            setTimeout(setupDisplayMapping, 1500);
          });
        } else {
          setTimeout(setupDisplayMapping, 1500);
        }

        // Function to sync total price from visualizer to modal
        function syncTotalPrice() {
          const visualizerTotal = document.getElementById(
            "slider-total-price-display-visualizer"
          );
          const visualizerPerUnit = document.getElementById(
            "slider-total-price-per-unit-visualizer"
          );
          const modalTotal = document.getElementById("order-total-display");
          const modalPerUnit = document.getElementById("order-total-per-unit");

          if (visualizerTotal && modalTotal) {
            const visualizerPrice = visualizerTotal.innerText.trim();
            if (visualizerPrice && visualizerPrice !== "$0.00") {
              modalTotal.innerText = visualizerPrice;
            }
          }

          if (visualizerPerUnit && modalPerUnit) {
            const perUnitText = visualizerPerUnit.innerText.trim();
            if (perUnitText && perUnitText !== "$0.00") {
              // Remove any existing /copy or /per unit suffix
              const priceOnly = perUnitText.replace(/\/.*$/, "");
              modalPerUnit.innerText = priceOnly + "/copy";
            }
          }
        }

        // Also run when modal opens
        const modal = document.getElementById("pricing-breakdown-modal");
        if (modal) {
          const modalObserver = new MutationObserver(() => {
            if (modal.classList.contains("visible")) {
              setTimeout(setupDisplayMapping, 100);
              // Sync total price from visualizer to modal after a delay to ensure builder.js has run
              setTimeout(() => {
                syncTotalPrice();
                // Also sync after builder.js updates (give it a moment)
                setTimeout(syncTotalPrice, 200);
              }, 100);
            }
          });
          modalObserver.observe(modal, {
            attributes: true,
            attributeFilter: ["class"],
          });
        }

        // Watch for changes to the visualizer total price and sync to modal
        function setupPriceSync() {
          const visualizerTotal = document.getElementById(
            "slider-total-price-display-visualizer"
          );
          const visualizerPerUnit = document.getElementById(
            "slider-total-price-per-unit-visualizer"
          );

          if (visualizerTotal) {
            const totalObserver = new MutationObserver(() => {
              // Only sync if modal is visible
              if (modal && modal.classList.contains("visible")) {
                syncTotalPrice();
              }
            });
            totalObserver.observe(visualizerTotal, {
              childList: true,
              characterData: true,
              subtree: true,
            });
          }

          if (visualizerPerUnit) {
            const perUnitObserver = new MutationObserver(() => {
              // Only sync if modal is visible
              if (modal && modal.classList.contains("visible")) {
                syncTotalPrice();
              }
            });
            perUnitObserver.observe(visualizerPerUnit, {
              childList: true,
              characterData: true,
              subtree: true,
            });
          }
        }

        // Set up price sync after DOM is ready
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", () => {
            setTimeout(setupPriceSync, 1000);
          });
        } else {
          setTimeout(setupPriceSync, 1000);
        }
      })();

      // Load and populate color options from colors.json
      (function () {
        let colorsData = null;

        // Map JSON color types to record types and container IDs
        const colorTypeMap = {
          ecomix: {
            recordTypes: ["eco-mix"],
            containerId: "ecomix-options-container",
          },
          "solids - translucent": {
            recordTypes: ["solids-translucent", "splatter", "two-color"],
            containerId: "soilds-translucent-options-container",
          },
          "solids - opaque": {
            recordTypes: ["solids-opaque"],
            containerId: "soilds-opaque-options-container",
          },
          "solids - neon": {
            recordTypes: ["solids-neon"],
            containerId: "soilds-opaque-options-container", // Fallback to opaque container
          },
          "standard (mb) blends": {
            recordTypes: ["standard-blends"],
            containerId: "standard-blends-options-container",
          },
          "deluxe (md) blends": {
            recordTypes: ["deluxe-blends"],
            containerId: "deluxe-blends-options-container",
          },
          "metallic (hb) blends": {
            recordTypes: ["deluxe-blends"], // Map to deluxe blends
            containerId: "deluxe-blends-options-container",
          },
          "smoke (sb) blends": {
            recordTypes: ["standard-blends"], // Map to standard blends
            containerId: "standard-blends-options-container",
          },
          "cream (cb) blends": {
            recordTypes: ["standard-blends"], // Map to standard blends
            containerId: "standard-blends-options-container",
          },
        };

        // Function to create a color option element
        function createColorOption(color, options = {}) {
          const option = document.createElement("div");
          // Add base class
          option.className = "memphis-color-option";

          // Add additional classes based on context
          if (options.isRecordColor) {
            option.classList.add("record-color-option");
          }
          if (options.isSplatterColor) {
            option.classList.add("splatter-color-option");
            option.classList.add("color-picker-option");
          }
          if (options.isInSplatterContainer) {
            option.classList.add("color-picker-option");
          }

          option.setAttribute("data-name", color.name);
          option.setAttribute("data-image-url", color.imageUrl);
          option.style.backgroundImage = `url(${color.imageUrl})`;
          option.style.backgroundSize = "cover";
          option.style.backgroundPosition = "center";
          option.title = color.fullName || color.name;
          return option;
        }

        // Function to populate color containers
        function populateColorContainers() {
          if (!colorsData) return;

          // Map container IDs to their modal equivalents
          const containerMap = {
            "ecomix-options-container": "ecomix-options-container-modal",
            "soilds-translucent-options-container":
              "soilds-translucent-options-container-modal",
            "soilds-opaque-options-container":
              "soilds-opaque-options-container-modal",
            "standard-blends-options-container":
              "standard-blends-options-container-modal",
            "deluxe-blends-options-container":
              "deluxe-blends-options-container-modal",
          };

          // Clear all containers first (both regular and modal)
          const containers = [
            "ecomix-options-container",
            "soilds-translucent-options-container",
            "soilds-opaque-options-container",
            "standard-blends-options-container",
            "deluxe-blends-options-container",
          ];

          containers.forEach((containerId) => {
            const container = document.getElementById(containerId);
            if (container) {
              container.innerHTML = "";
            }
            // Also clear modal container
            const modalContainerId = containerMap[containerId];
            if (modalContainerId) {
              const modalContainer = document.getElementById(modalContainerId);
              if (modalContainer) {
                modalContainer.innerHTML = "";
              }
            }
          });

          // Populate containers based on color type (both regular and modal)
          colorsData.forEach((color) => {
            const mapping = colorTypeMap[color.type];
            if (mapping) {
              const container = document.getElementById(mapping.containerId);
              if (container) {
                // Determine if this is a record color container
                const isRecordColor =
                  mapping.containerId.includes("record") ||
                  mapping.containerId.includes("ecomix") ||
                  mapping.containerId.includes("soilds-opaque") ||
                  mapping.containerId.includes("standard-blends") ||
                  mapping.containerId.includes("deluxe-blends");
                const option = createColorOption(color, {
                  isRecordColor: isRecordColor,
                });
                container.appendChild(option);
              }
              // Also populate modal container
              const modalContainerId = containerMap[mapping.containerId];
              if (modalContainerId) {
                const modalContainer =
                  document.getElementById(modalContainerId);
                if (modalContainer) {
                  const isRecordColor =
                    mapping.containerId.includes("record") ||
                    mapping.containerId.includes("ecomix") ||
                    mapping.containerId.includes("soilds-opaque") ||
                    mapping.containerId.includes("standard-blends") ||
                    mapping.containerId.includes("deluxe-blends");
                  // Translucent colors can be used for splatter, so add those classes too
                  const isSplatterColor =
                    mapping.containerId.includes("soilds-translucent");
                  const modalOption = createColorOption(color, {
                    isRecordColor: isRecordColor,
                    isSplatterColor: isSplatterColor,
                    isInSplatterContainer: isSplatterColor,
                  });
                  modalContainer.appendChild(modalOption);
                }
              }
            }
          });

          // Also populate splatter color containers (use translucent colors)
          const splatterContainers = [
            "soilds-translucent-options-container-splatter-one",
            "soilds-translucent-options-container-splatter-two",
            "soilds-translucent-options-container-splatter-three",
          ];

          const splatterColors = colorsData.filter(
            (c) => c.type === "solids - translucent"
          );

          splatterContainers.forEach((containerId) => {
            const container = document.getElementById(containerId);
            if (container) {
              container.innerHTML = "";
              // Add splatter-colors class for jQuery compatibility
              container.classList.add("splatter-colors");
              container.classList.add("splater-colors"); // Support both spellings
              splatterColors.forEach((color) => {
                const option = createColorOption(color, {
                  isSplatterColor: true,
                  isInSplatterContainer: true,
                });
                container.appendChild(option);
              });
            }
          });
        }

        // Load colors.json
        async function loadColors() {
          try {
            const response = await fetch("./colors.json");
            if (!response.ok) {
              throw new Error("Failed to load colors.json");
            }
            colorsData = await response.json();
            populateColorContainers();
          } catch (error) {
            console.error("Error loading colors:", error);
          }
        }

        // Initialize when DOM is ready
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", () => {
            setTimeout(loadColors, 100);
          });
        } else {
          setTimeout(loadColors, 100);
        }

        // Also try after builder.js loads
        window.addEventListener("load", () => {
          setTimeout(() => {
            if (colorsData) {
              populateColorContainers();
            } else {
              loadColors();
            }
          }, 500);
        });

        // Color Picker Modal functionality
        const colorPickerModal = document.getElementById("color-picker-modal");
        const colorPickerCloseButton = document.getElementById(
          "color-picker-close-button"
        );
        const recordColorButton = document.getElementById(
          "record-color-button"
        );

        // Track which input we're selecting a color for
        let currentColorSelectionTarget = null; // 'record', 'splatter-1', 'splatter-2', 'splatter-3'

        // Map record types to modal container IDs
        const recordTypeToModalContainer = {
          "eco-mix": "ecomix-options-container-modal",
          "solids-translucent": "soilds-translucent-options-container-modal",
          "solids-opaque": "soilds-opaque-options-container-modal",
          "solids-neon": "soilds-opaque-options-container-modal", // Neon uses same container as opaque
          "standard-blends": "standard-blends-options-container-modal",
          "deluxe-blends": "deluxe-blends-options-container-modal",
          splatter: "soilds-opaque-options-container-modal", // Splatter uses solids-opaque as base
        };

        // Function to show the appropriate color container in modal
        function showModalColorContainer(recordType, isSplatterColor = false) {
          // Hide all modal containers and remove splatter-colors class
          const modalContainers = [
            "ecomix-options-container-modal",
            "soilds-translucent-options-container-modal",
            "soilds-opaque-options-container-modal",
            "standard-blends-options-container-modal",
            "deluxe-blends-options-container-modal",
          ];

          modalContainers.forEach((containerId) => {
            const container = document.getElementById(containerId);
            if (container) {
              container.style.display = "none";
              // Remove splatter-colors class from all containers
              container.classList.remove("splatter-colors");
              container.classList.remove("splater-colors");
            }
          });

          // Show the appropriate container
          const containerId = recordTypeToModalContainer[recordType];
          if (containerId) {
            const container = document.getElementById(containerId);
            if (container) {
              container.style.display = "grid";

              // If showing neon colors, filter to show only neon colors
              if (recordType === "solids-neon") {
                // Hide all color options first
                const allOptions = container.querySelectorAll(
                  ".memphis-color-option"
                );
                allOptions.forEach((option) => {
                  option.style.display = "none";
                });

                // Show only neon colors (if colorsData is loaded, otherwise show all and filter later)
                if (colorsData) {
                  const neonColors = colorsData.filter(
                    (c) => c.type === "solids - neon"
                  );
                  neonColors.forEach((neonColor) => {
                    const colorName = neonColor.name;
                    const neonOption = Array.from(allOptions).find(
                      (opt) => opt.getAttribute("data-name") === colorName
                    );
                    if (neonOption) {
                      neonOption.style.display = "block";
                    }
                  });
                } else {
                  // If colorsData not loaded yet, show all and filter when it loads
                  // This ensures the modal opens even if data isn't ready
                  allOptions.forEach((option) => {
                    option.style.display = "block";
                  });
                }
              } else {
                // For other types, show all colors in the container
                const allOptions = container.querySelectorAll(
                  ".memphis-color-option"
                );
                allOptions.forEach((option) => {
                  option.style.display = "block";
                });
              }

              // Add splatter-colors class if this is for splatter color selection
              if (isSplatterColor) {
                container.classList.add("splatter-colors");
                container.classList.add("splater-colors"); // Support both spellings
              }
            }
          }
        }

        // Open modal when "Select Color" button is clicked
        // Wait for builder.js to load, then override its behavior
        function setupColorPickerModal() {
          const recordColorButton = document.getElementById(
            "record-color-button"
          );
          const splatterColorOneButton = document.getElementById(
            "splatter-color-one-button"
          );
          const splatterColorTwoButton = document.getElementById(
            "splatter-color-two-button"
          );
          const splatterColorThreeButton = document.getElementById(
            "splatter-color-three-button"
          );
          const colorPickerModal =
            document.getElementById("color-picker-modal");

          // Function to open modal for a specific target
          function openColorModal(target, recordType) {
            if (!recordType || recordType === "black") {
              console.log("Modal not opened - recordType:", recordType);
              return;
            }

            console.log("Opening color modal for:", { target, recordType });

            // Prevent old dropdowns from opening
            const oldPickers = [
              document.getElementById("record-color-picker-container"),
              document.getElementById("splatter-picker-color-one-container"),
              document.getElementById("splatter-picker-color-two-container"),
              document.getElementById("splatter-picker-color-three-container"),
            ];
            oldPickers.forEach((picker) => {
              if (picker) picker.classList.remove("visible");
            });

            currentColorSelectionTarget = target;

            // Determine if this is for splatter color selection
            const isSplatterColor = target.startsWith("splatter-");

            // Update modal title
            const modalTitle = document.querySelector(
              ".color-picker-modal-title"
            );
            if (modalTitle) {
              if (isSplatterColor) {
                modalTitle.textContent = "Select Splatter Color";
              } else {
                modalTitle.textContent = "Select Record Color";
              }
            }

            showModalColorContainer(recordType, isSplatterColor);
            colorPickerModal.classList.add("visible");
            document.body.style.overflow = "hidden";
          }

          if (recordColorButton && colorPickerModal) {
            // Use capture phase to intercept before builder.js
            // But make sure we only handle clicks on the record-color-button specifically
            recordColorButton.addEventListener(
              "click",
              (e) => {
                // Only handle if this is actually the record-color-button or its children
                const clickedElement = e.target;
                const isRecordColorButton =
                  clickedElement.id === "record-color-button" ||
                  clickedElement.closest("#record-color-button") !== null;

                // Explicitly exclude pricing breakdown buttons
                const isPricingButton =
                  clickedElement.id === "pricing-breakdown-button" ||
                  clickedElement.id === "pricing-breakdown-button-visualizer" ||
                  clickedElement.id === "pricing-breakdown-button-mobile" ||
                  clickedElement.closest("#pricing-breakdown-button") !==
                    null ||
                  clickedElement.closest(
                    "#pricing-breakdown-button-visualizer"
                  ) !== null ||
                  clickedElement.closest("#pricing-breakdown-button-mobile") !==
                    null;

                if (!isRecordColorButton || isPricingButton) {
                  return; // Not our button or it's a pricing button, let it pass through
                }

                e.stopPropagation();
                e.preventDefault();
                const recordTypeInput = document.getElementById("record-type");
                if (recordTypeInput && recordTypeInput.value) {
                  openColorModal("record", recordTypeInput.value);
                  return false;
                }
              },
              true
            ); // Use capture phase
          }

          // Set up splatter color buttons
          if (splatterColorOneButton && colorPickerModal) {
            splatterColorOneButton.addEventListener(
              "click",
              (e) => {
                e.stopPropagation();
                const recordTypeInput = document.getElementById("record-type");
                if (recordTypeInput && recordTypeInput.value === "splatter") {
                  openColorModal("splatter-1", "solids-translucent");
                  return false;
                }
              },
              true
            );
          }

          if (splatterColorTwoButton && colorPickerModal) {
            splatterColorTwoButton.addEventListener(
              "click",
              (e) => {
                e.stopPropagation();
                const recordTypeInput = document.getElementById("record-type");
                if (recordTypeInput && recordTypeInput.value === "splatter") {
                  openColorModal("splatter-2", "solids-translucent");
                  return false;
                }
              },
              true
            );
          }

          if (splatterColorThreeButton && colorPickerModal) {
            splatterColorThreeButton.addEventListener(
              "click",
              (e) => {
                e.stopPropagation();
                const recordTypeInput = document.getElementById("record-type");
                if (recordTypeInput && recordTypeInput.value === "splatter") {
                  openColorModal("splatter-3", "solids-translucent");
                  return false;
                }
              },
              true
            );
          }
        }

        // Set up after builder.js loads
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", () => {
            setTimeout(setupColorPickerModal, 1500);
          });
        } else {
          setTimeout(setupColorPickerModal, 1500);
        }

        window.addEventListener("load", () => {
          setTimeout(setupColorPickerModal, 2000);
        });

        // Close modal handlers
        function closeColorPickerModal() {
          if (colorPickerModal) {
            colorPickerModal.classList.remove("visible");
            document.body.style.overflow = "";
            currentColorSelectionTarget = null;
          }
        }

        if (colorPickerCloseButton) {
          colorPickerCloseButton.addEventListener("click", (e) => {
            e.stopPropagation();
            closeColorPickerModal();
          });
        }

        // Close modal when clicking backdrop
        if (colorPickerModal) {
          colorPickerModal.addEventListener("click", (e) => {
            if (e.target === colorPickerModal) {
              closeColorPickerModal();
            }
          });
        }

        // Handle color selection in modal - trigger builder.js logic
        if (colorPickerModal) {
          colorPickerModal.addEventListener("click", (e) => {
            if (e.target.classList.contains("memphis-color-option")) {
              e.stopPropagation();

              // Get color data from the clicked element
              const colorName = e.target.getAttribute("data-name");
              const imageUrl = e.target.getAttribute("data-image-url");

              // Determine which input we're updating based on currentColorSelectionTarget
              if (currentColorSelectionTarget === "record") {
                // Handle record color selection
                const recordColorNameDisplay = document.getElementById(
                  "selected-record-color-name"
                );
                const recordColorInput =
                  document.getElementById("record-color");
                const recordColorButton = document.getElementById(
                  "record-color-button"
                );
                const recordVisualDisplay = document.getElementById(
                  "builder-record-display"
                );
                const recordTypeInput = document.getElementById("record-type");

                // Update display with swatch and name
                const recordColorDisplay = document.getElementById(
                  "selected-record-color-display"
                );
                const recordColorSwatch = document.getElementById(
                  "selected-record-color-swatch"
                );

                if (recordColorNameDisplay) {
                  recordColorNameDisplay.innerText = colorName;
                }

                // Update swatch image
                if (recordColorSwatch && imageUrl) {
                  recordColorSwatch.style.backgroundImage = `url(${imageUrl})`;
                  recordColorSwatch.style.backgroundSize = "cover";
                  recordColorSwatch.style.backgroundPosition = "center";
                  recordColorSwatch.style.backgroundRepeat = "no-repeat";
                  recordColorSwatch.style.display = "block";
                }

                if (recordColorDisplay) {
                  recordColorDisplay.style.display = "flex";
                }

                // Update button
                if (recordColorButton) {
                  recordColorButton.classList.add("color-selected");
                }

                // Update input
                if (recordColorInput) {
                  recordColorInput.value = colorName;
                }

                // Update visual display (including eco-mix)
                if (recordVisualDisplay && recordTypeInput) {
                  recordVisualDisplay.style.backgroundImage = `url(${imageUrl})`;
                  recordVisualDisplay.style.backgroundSize = "cover";
                  recordVisualDisplay.style.backgroundPosition = "center";
                  recordVisualDisplay.style.backgroundRepeat = "no-repeat";
                }

                // Also update all record discs for eco-mix and other types
                const recordDisc1 = document.getElementById(
                  "builder-record-display"
                );
                const recordDisc2 = document.getElementById(
                  "builder-record-display-2"
                );
                const recordDisc3 = document.getElementById(
                  "builder-record-display-3"
                );

                [recordDisc1, recordDisc2, recordDisc3].forEach((disc) => {
                  if (disc) {
                    disc.style.backgroundImage = `url(${imageUrl})`;
                    disc.style.backgroundSize = "cover";
                    disc.style.backgroundPosition = "center";
                    disc.style.backgroundRepeat = "no-repeat";
                  }
                });

                // Update builder.js's selected state
                if (typeof selected !== "undefined") {
                  selected.recordColorName = colorName;

                  // Trigger price calculations
                  if (typeof getRecordPrice === "function") {
                    getRecordPrice();
                  }
                  if (typeof getTotalPrice === "function") {
                    getTotalPrice();
                  }
                }

                // Trigger jQuery events for record color selection
                if (typeof jQuery !== "undefined") {
                  // Remove selected class from all record color options
                  jQuery(".record-color-option").removeClass(
                    "selected-effect-color"
                  );
                  jQuery(".record-color-option").removeClass(
                    "selected-record-color"
                  );

                  // Add selected classes to clicked option
                  jQuery(e.target).addClass("selected-effect-color");
                  jQuery(e.target).addClass("selected-record-color");

                  // Trigger click event for jQuery handlers
                  jQuery(e.target).trigger("click");
                }

                // Trigger change event for builder.js
                if (recordColorInput) {
                  recordColorInput.dispatchEvent(
                    new Event("change", { bubbles: true })
                  );
                  recordColorInput.dispatchEvent(
                    new Event("input", { bubbles: true })
                  );
                }
              } else if (currentColorSelectionTarget === "splatter-1") {
                // Handle splatter color 1 selection
                const splatterColorOneInput =
                  document.getElementById("splatter-color-one");
                const splatterColorOneButton = document.getElementById(
                  "splatter-color-one-button"
                );
                const splatterColorOneDisplay = document.getElementById(
                  "selected-splatter-color-one-name"
                );

                if (splatterColorOneInput) {
                  splatterColorOneInput.value = colorName;
                  // Trigger both change and input events to ensure effect listeners fire
                  splatterColorOneInput.dispatchEvent(
                    new Event("change", { bubbles: true })
                  );
                  splatterColorOneInput.dispatchEvent(
                    new Event("input", { bubbles: true })
                  );
                }

                if (splatterColorOneButton) {
                  splatterColorOneButton.classList.add("color-selected");
                }

                if (splatterColorOneDisplay) {
                  splatterColorOneDisplay.innerText = colorName;
                  splatterColorOneDisplay.parentElement.style.color = "black";
                }

                if (typeof selected !== "undefined") {
                  selected.splatterOneColorName = colorName;
                }

                // Trigger effect application immediately
                if (typeof window.applySplatterEffect === "function") {
                  setTimeout(() => {
                    window.applySplatterEffect();
                  }, 50);
                }

                // Trigger jQuery events for splatter color selection
                if (typeof jQuery !== "undefined") {
                  // Toggle selected class
                  if (jQuery(e.target).hasClass("selected-effect-color")) {
                    jQuery(e.target).removeClass("selected-effect-color");
                    jQuery(e.target).css("pointer-events", "");
                  } else {
                    jQuery(e.target).addClass("selected-effect-color");
                    jQuery(e.target).css("pointer-events", "none");
                  }
                  // Trigger click event for jQuery handlers
                  jQuery(e.target).trigger("click");
                }
              } else if (currentColorSelectionTarget === "splatter-2") {
                // Handle splatter color 2 selection
                const splatterColorTwoInput =
                  document.getElementById("splatter-color-two");
                const splatterColorTwoButton = document.getElementById(
                  "splatter-color-two-button"
                );
                const splatterColorTwoDisplay = document.getElementById(
                  "selected-splatter-color-two-name"
                );

                if (splatterColorTwoInput) {
                  splatterColorTwoInput.value = colorName;
                  // Trigger both change and input events to ensure effect listeners fire
                  splatterColorTwoInput.dispatchEvent(
                    new Event("change", { bubbles: true })
                  );
                  splatterColorTwoInput.dispatchEvent(
                    new Event("input", { bubbles: true })
                  );
                }

                if (splatterColorTwoButton) {
                  splatterColorTwoButton.classList.add("color-selected");
                }

                if (splatterColorTwoDisplay) {
                  splatterColorTwoDisplay.innerText = colorName;
                  splatterColorTwoDisplay.parentElement.style.color = "black";
                }

                if (typeof selected !== "undefined") {
                  selected.splatterTwoColorName = colorName;
                }

                // Trigger effect application immediately
                if (typeof window.applySplatterEffect === "function") {
                  setTimeout(() => {
                    window.applySplatterEffect();
                  }, 50);
                }

                // Trigger jQuery events for splatter color selection
                if (typeof jQuery !== "undefined") {
                  // Toggle selected class
                  if (jQuery(e.target).hasClass("selected-effect-color")) {
                    jQuery(e.target).removeClass("selected-effect-color");
                    jQuery(e.target).css("pointer-events", "");
                  } else {
                    jQuery(e.target).addClass("selected-effect-color");
                    jQuery(e.target).css("pointer-events", "none");
                  }
                  // Trigger click event for jQuery handlers
                  jQuery(e.target).trigger("click");
                }
              } else if (currentColorSelectionTarget === "splatter-3") {
                // Handle splatter color 3 selection
                const splatterColorThreeInput = document.getElementById(
                  "splatter-color-three"
                );
                const splatterColorThreeButton = document.getElementById(
                  "splatter-color-three-button"
                );
                const splatterColorThreeDisplay = document.getElementById(
                  "selected-splatter-color-three-name"
                );

                if (splatterColorThreeInput) {
                  splatterColorThreeInput.value = colorName;
                  // Trigger both change and input events to ensure effect listeners fire
                  splatterColorThreeInput.dispatchEvent(
                    new Event("change", { bubbles: true })
                  );
                  splatterColorThreeInput.dispatchEvent(
                    new Event("input", { bubbles: true })
                  );
                }

                if (splatterColorThreeButton) {
                  splatterColorThreeButton.classList.add("color-selected");
                }

                if (splatterColorThreeDisplay) {
                  splatterColorThreeDisplay.innerText = colorName;
                  splatterColorThreeDisplay.parentElement.style.color = "black";
                }

                if (typeof selected !== "undefined") {
                  selected.splatterThreeColorName = colorName;
                }

                // Trigger effect application immediately
                if (typeof window.applySplatterEffect === "function") {
                  setTimeout(() => {
                    window.applySplatterEffect();
                  }, 50);
                }

                // Trigger jQuery events for splatter color selection
                if (typeof jQuery !== "undefined") {
                  // Toggle selected class
                  if (jQuery(e.target).hasClass("selected-effect-color")) {
                    jQuery(e.target).removeClass("selected-effect-color");
                    jQuery(e.target).css("pointer-events", "");
                  } else {
                    jQuery(e.target).addClass("selected-effect-color");
                    jQuery(e.target).css("pointer-events", "none");
                  }
                  // Trigger click event for jQuery handlers
                  jQuery(e.target).trigger("click");
                }
              }

              // Close modal
              setTimeout(() => {
                closeColorPickerModal();
              }, 100);
            }
          });
        }

        // Sync swatch when builder.js updates color name
        function syncColorSwatch() {
          const recordColorNameDisplay = document.getElementById(
            "selected-record-color-name"
          );
          const recordColorSwatch = document.getElementById(
            "selected-record-color-swatch"
          );

          if (recordColorNameDisplay && recordColorSwatch) {
            const colorName = recordColorNameDisplay.innerText.trim();

            // If a color is selected, find its image URL from the colors data
            if (colorName && colorName !== "No color selected" && colorsData) {
              const color = colorsData.find((c) => c.name === colorName);
              if (color && color.imageUrl) {
                recordColorSwatch.style.backgroundImage = `url(${color.imageUrl})`;
                recordColorSwatch.style.backgroundSize = "cover";
                recordColorSwatch.style.backgroundPosition = "center";
                recordColorSwatch.style.backgroundRepeat = "no-repeat";
                recordColorSwatch.style.display = "block";
              } else {
                recordColorSwatch.style.display = "none";
              }
            } else {
              // Hide swatch if no color selected
              recordColorSwatch.style.backgroundImage = "";
              recordColorSwatch.style.display = "none";
            }
          }
        }

        // Watch for changes to the color name display
        function setupColorSwatchSync() {
          const recordColorNameDisplay = document.getElementById(
            "selected-record-color-name"
          );

          if (recordColorNameDisplay) {
            const observer = new MutationObserver(() => {
              syncColorSwatch();
            });

            observer.observe(recordColorNameDisplay, {
              childList: true,
              characterData: true,
              subtree: true,
            });

            // Initial sync
            syncColorSwatch();
          }
        }

        // Set up swatch sync after colors are loaded
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", () => {
            setTimeout(() => {
              if (colorsData) {
                setupColorSwatchSync();
              }
            }, 2000);
          });
        } else {
          setTimeout(() => {
            if (colorsData) {
              setupColorSwatchSync();
            }
          }, 2000);
        }

        window.addEventListener("load", () => {
          setTimeout(() => {
            if (colorsData) {
              setupColorSwatchSync();
            }
          }, 2500);
        });

        // Load and apply effects
        (function () {
          let effectsData = null;
          let colorsDataForEffects = null;

          // Get colorsData from the color picker function scope
          // We'll need to access it from the parent scope or reload it
          async function loadColorsForEffects() {
            try {
              const response = await fetch("./colors.json");
              if (!response.ok) {
                throw new Error("Failed to load colors.json");
              }
              colorsDataForEffects = await response.json();
            } catch (error) {
              console.error("Error loading colors for effects:", error);
            }
          }

          // Load effects.json
          async function loadEffects() {
            try {
              const response = await fetch("./effects.json");
              if (!response.ok) {
                throw new Error("Failed to load effects.json");
              }
              effectsData = await response.json();
              // Also load colors for effects
              await loadColorsForEffects();
              setupEffectListeners();
              // Expose function to window for external calls
              window.applySplatterEffect = applySplatterEffect;
            } catch (error) {
              console.error("Error loading effects:", error);
            }
          }

          // Apply splatter effect to record displays
          function applySplatterEffect() {
            const splatterEffect = effectsData?.find(
              (e) => e.slug === "splatter"
            );
            if (!splatterEffect) {
              console.log(
                "Splatter effect not found in effectsData",
                effectsData
              );
              return;
            }

            // Get splatter color selections
            const splatterColorOneInput =
              document.getElementById("splatter-color-one");
            const splatterColorTwoInput =
              document.getElementById("splatter-color-two");
            const splatterColorThreeInput = document.getElementById(
              "splatter-color-three"
            );

            const splatterColor1 = splatterColorOneInput?.value || null;
            const splatterColor2 = splatterColorTwoInput?.value || null;
            const splatterColor3 = splatterColorThreeInput?.value || null;

            console.log("Applying splatter effect:", {
              splatterColor1,
              splatterColor2,
              splatterColor3,
              effectImage: splatterEffect.effectImage,
            });

            // Get base color (should be from solids-opaque for splatter)
            const recordColorInput = document.getElementById("record-color");
            const baseColorName = recordColorInput?.value || null;

            // Get all record discs
            const recordDisc1 = document.getElementById(
              "builder-record-display"
            );
            const recordDisc2 = document.getElementById(
              "builder-record-display-2"
            );
            const recordDisc3 = document.getElementById(
              "builder-record-display-3"
            );

            const recordDiscs = [recordDisc1, recordDisc2, recordDisc3];

            console.log(
              "Record discs found:",
              recordDiscs.map((d) => (d ? "found" : "missing"))
            );

            recordDiscs.forEach((disc, index) => {
              if (!disc) return;

              // Get effect layers for this disc
              const layer1 = disc.querySelector(".effect-layer-1");
              const layer2 = disc.querySelector(".effect-layer-2");
              const layer3 = disc.querySelector(".effect-layer-3");

              console.log(`Disc ${index + 1} layers:`, {
                layer1: layer1 ? "found" : "missing",
                layer2: layer2 ? "found" : "missing",
                layer3: layer3 ? "found" : "missing",
              });

              // Apply base color to record (if selected)
              // This applies to splatter base colors, but also handle eco-mix if selected
              if (baseColorName && colorsDataForEffects) {
                const baseColor = colorsDataForEffects.find(
                  (c) => c.name === baseColorName
                );
                if (baseColor && baseColor.imageUrl) {
                  disc.style.backgroundImage = `url(${baseColor.imageUrl})`;
                  disc.style.backgroundSize = "cover";
                  disc.style.backgroundPosition = "center";
                  disc.style.backgroundRepeat = "no-repeat";
                }
              }

              // Apply layer 1 with splatter color 1 (if selected)
              if (layer1 && splatterEffect.effectImage) {
                if (splatterColor1 && colorsDataForEffects) {
                  const color1 = colorsDataForEffects.find(
                    (c) => c.name === splatterColor1
                  );
                  if (color1 && color1.imageUrl) {
                    // Use the effect image as a mask
                    // The effect image has black splatter on white background
                    // We want: black areas = show color, white areas = transparent
                    // CSS mask with luminance: white=visible, black=hidden
                    // So we need to invert the mask
                    // We'll use mask-composite to subtract from white, or use a filter
                    layer1.style.backgroundImage = `url(${color1.imageUrl})`;
                    // The effect image has black splatter on white background
                    // We want: black areas = show color, white areas = transparent
                    // Use mask-composite to invert: white gradient minus effect image
                    layer1.style.maskImage = `linear-gradient(white, white), url(${splatterEffect.effectImage})`;
                    layer1.style.webkitMaskImage = `linear-gradient(white, white), url(${splatterEffect.effectImage})`;
                    // Use exclude to invert (white - effect = black areas visible)
                    layer1.style.maskComposite = "exclude";
                    layer1.style.webkitMaskComposite = "xor";
                    // Ensure mask mode is set
                    layer1.style.maskMode = "luminance";
                    layer1.style.webkitMaskMode = "luminance";
                    layer1.style.maskSize = "cover, cover";
                    layer1.style.webkitMaskSize = "cover, cover";
                    layer1.style.maskPosition = "center, center";
                    layer1.style.webkitMaskPosition = "center, center";
                    layer1.style.maskRepeat = "no-repeat, no-repeat";
                    layer1.style.webkitMaskRepeat = "no-repeat, no-repeat";
                    layer1.style.opacity = "1";
                    layer1.style.display = "block";

                    console.log("Applied layer1 mask:", {
                      maskImage: layer1.style.maskImage,
                      maskComposite: layer1.style.maskComposite,
                      backgroundImage: layer1.style.backgroundImage,
                    });
                  }
                } else {
                  layer1.style.opacity = "0";
                }
              }

              // Apply layer 2 with splatter color 2 (if selected)
              if (layer2 && splatterEffect.effectLayer2) {
                if (splatterColor2 && colorsDataForEffects) {
                  const color2 = colorsDataForEffects.find(
                    (c) => c.name === splatterColor2
                  );
                  if (color2 && color2.imageUrl) {
                    layer2.style.backgroundImage = `url(${color2.imageUrl})`;
                    // Invert mask for layer 2
                    layer2.style.maskImage = `linear-gradient(white, white), url(${splatterEffect.effectLayer2})`;
                    layer2.style.webkitMaskImage = `linear-gradient(white, white), url(${splatterEffect.effectLayer2})`;
                    layer2.style.maskComposite = "exclude";
                    layer2.style.webkitMaskComposite = "xor";
                    layer2.style.maskMode = "luminance";
                    layer2.style.webkitMaskMode = "luminance";
                    layer2.style.maskSize = "cover, cover";
                    layer2.style.webkitMaskSize = "cover, cover";
                    layer2.style.maskPosition = "center, center";
                    layer2.style.webkitMaskPosition = "center, center";
                    layer2.style.maskRepeat = "no-repeat, no-repeat";
                    layer2.style.webkitMaskRepeat = "no-repeat, no-repeat";
                    layer2.style.opacity = "1";
                    layer2.style.display = "block";
                  }
                } else {
                  layer2.style.opacity = "0";
                }
              }

              // Apply layer 3 with splatter color 3 (if selected)
              if (layer3 && splatterEffect.effectLayer3) {
                if (splatterColor3 && colorsDataForEffects) {
                  const color3 = colorsDataForEffects.find(
                    (c) => c.name === splatterColor3
                  );
                  if (color3 && color3.imageUrl) {
                    layer3.style.backgroundImage = `url(${color3.imageUrl})`;
                    // Invert mask for layer 3
                    layer3.style.maskImage = `linear-gradient(white, white), url(${splatterEffect.effectLayer3})`;
                    layer3.style.webkitMaskImage = `linear-gradient(white, white), url(${splatterEffect.effectLayer3})`;
                    layer3.style.maskComposite = "exclude";
                    layer3.style.webkitMaskComposite = "xor";
                    layer3.style.maskMode = "luminance";
                    layer3.style.webkitMaskMode = "luminance";
                    layer3.style.maskSize = "cover, cover";
                    layer3.style.webkitMaskSize = "cover, cover";
                    layer3.style.maskPosition = "center, center";
                    layer3.style.webkitMaskPosition = "center, center";
                    layer3.style.maskRepeat = "no-repeat, no-repeat";
                    layer3.style.webkitMaskRepeat = "no-repeat, no-repeat";
                    layer3.style.opacity = "1";
                    layer3.style.display = "block";
                  }
                } else {
                  layer3.style.opacity = "0";
                }
              }
            });

            // Sync effect layers from disc 1 to other visible discs
            if (recordDisc1) {
              const syncLayers = () => {
                const layer1 = recordDisc1.querySelector(".effect-layer-1");
                const layer2 = recordDisc1.querySelector(".effect-layer-2");
                const layer3 = recordDisc1.querySelector(".effect-layer-3");

                // Helper function to copy all mask and style properties
                const copyLayerStyles = (source, target) => {
                  if (!source || !target) return;
                  target.style.backgroundImage = source.style.backgroundImage;
                  target.style.opacity = source.style.opacity;
                  target.style.maskImage = source.style.maskImage;
                  target.style.webkitMaskImage = source.style.webkitMaskImage;
                  target.style.maskComposite = source.style.maskComposite;
                  target.style.webkitMaskComposite =
                    source.style.webkitMaskComposite;
                  target.style.maskSize = source.style.maskSize;
                  target.style.webkitMaskSize = source.style.webkitMaskSize;
                  target.style.maskPosition = source.style.maskPosition;
                  target.style.webkitMaskPosition =
                    source.style.webkitMaskPosition;
                  target.style.maskRepeat = source.style.maskRepeat;
                  target.style.webkitMaskRepeat = source.style.webkitMaskRepeat;
                };

                if (layer1 && recordDisc2) {
                  const layer2_1 = recordDisc2.querySelector(".effect-layer-1");
                  copyLayerStyles(layer1, layer2_1);
                }
                if (layer2 && recordDisc2) {
                  const layer2_2 = recordDisc2.querySelector(".effect-layer-2");
                  copyLayerStyles(layer2, layer2_2);
                }
                if (layer3 && recordDisc2) {
                  const layer2_3 = recordDisc2.querySelector(".effect-layer-3");
                  copyLayerStyles(layer3, layer2_3);
                }

                if (layer1 && recordDisc3) {
                  const layer3_1 = recordDisc3.querySelector(".effect-layer-1");
                  copyLayerStyles(layer1, layer3_1);
                }
                if (layer2 && recordDisc3) {
                  const layer3_2 = recordDisc3.querySelector(".effect-layer-2");
                  copyLayerStyles(layer2, layer3_2);
                }
                if (layer3 && recordDisc3) {
                  const layer3_3 = recordDisc3.querySelector(".effect-layer-3");
                  copyLayerStyles(layer3, layer3_3);
                }
              };

              // Sync immediately
              syncLayers();

              // Watch for changes to disc 1's effect layers
              const layers = recordDisc1.querySelectorAll(
                ".record-effect-layer"
              );
              layers.forEach((layer) => {
                const observer = new MutationObserver(() => {
                  syncLayers();
                });
                observer.observe(layer, {
                  attributes: true,
                  attributeFilter: ["style"],
                  subtree: false,
                });
              });
            }
          }

          // Remove all effects
          function removeEffects() {
            const recordDiscs = [
              document.getElementById("builder-record-display"),
              document.getElementById("builder-record-display-2"),
              document.getElementById("builder-record-display-3"),
            ];

            recordDiscs.forEach((disc) => {
              if (!disc) return;

              const layers = disc.querySelectorAll(".record-effect-layer");
              layers.forEach((layer) => {
                layer.style.backgroundImage = "";
                layer.style.opacity = "0";
                layer.style.maskImage = "";
                layer.style.webkitMaskImage = "";
                layer.style.maskComposite = "";
                layer.style.webkitMaskComposite = "";
                layer.style.maskSize = "";
                layer.style.webkitMaskSize = "";
                layer.style.maskPosition = "";
                layer.style.webkitMaskPosition = "";
                layer.style.maskRepeat = "";
                layer.style.webkitMaskRepeat = "";
              });
            });
          }

          // Set up listeners for record type changes and splatter color changes
          function setupEffectListeners() {
            const recordTypeInput = document.getElementById("record-type");
            const recordColorInput = document.getElementById("record-color");
            const splatterColorOneInput =
              document.getElementById("splatter-color-one");
            const splatterColorTwoInput =
              document.getElementById("splatter-color-two");
            const splatterColorThreeInput = document.getElementById(
              "splatter-color-three"
            );

            // Function to check if splatter should be applied
            function checkAndApplySplatter() {
              const recordType = recordTypeInput?.value;
              if (recordType === "splatter") {
                applySplatterEffect();
              } else {
                removeEffects();
              }
            }

            if (recordTypeInput) {
              // Watch for changes to record type
              recordTypeInput.addEventListener("change", checkAndApplySplatter);

              // Initial check
              checkAndApplySplatter();
            }

            // Watch for base color changes (for splatter base)
            if (recordColorInput) {
              recordColorInput.addEventListener(
                "change",
                checkAndApplySplatter
              );
            }

            // Watch for splatter color changes
            if (splatterColorOneInput) {
              splatterColorOneInput.addEventListener(
                "change",
                checkAndApplySplatter
              );
            }
            if (splatterColorTwoInput) {
              splatterColorTwoInput.addEventListener(
                "change",
                checkAndApplySplatter
              );
            }
            if (splatterColorThreeInput) {
              splatterColorThreeInput.addEventListener(
                "change",
                checkAndApplySplatter
              );
            }

            // Also watch for programmatic changes via MutationObserver
            if (recordTypeInput) {
              const observer = new MutationObserver(() => {
                checkAndApplySplatter();
              });

              observer.observe(recordTypeInput, {
                attributes: true,
                attributeFilter: ["value"],
                subtree: false,
              });

              // Also poll for value changes (in case builder.js changes it directly)
              let lastRecordType = recordTypeInput.value;
              let lastBaseColor = recordColorInput?.value;
              let lastSplatter1 = splatterColorOneInput?.value;
              let lastSplatter2 = splatterColorTwoInput?.value;
              let lastSplatter3 = splatterColorThreeInput?.value;

              setInterval(() => {
                const currentRecordType = recordTypeInput.value;
                const currentBaseColor = recordColorInput?.value;
                const currentSplatter1 = splatterColorOneInput?.value;
                const currentSplatter2 = splatterColorTwoInput?.value;
                const currentSplatter3 = splatterColorThreeInput?.value;

                if (
                  currentRecordType !== lastRecordType ||
                  currentBaseColor !== lastBaseColor ||
                  currentSplatter1 !== lastSplatter1 ||
                  currentSplatter2 !== lastSplatter2 ||
                  currentSplatter3 !== lastSplatter3
                ) {
                  lastRecordType = currentRecordType;
                  lastBaseColor = currentBaseColor;
                  lastSplatter1 = currentSplatter1;
                  lastSplatter2 = currentSplatter2;
                  lastSplatter3 = currentSplatter3;
                  checkAndApplySplatter();
                }
              }, 200);
            }
          }

          // Initialize
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
              setTimeout(loadEffects, 100);
            });
          } else {
            setTimeout(loadEffects, 100);
          }

          window.addEventListener("load", () => {
            setTimeout(loadEffects, 500);
          });
        })();

        // Ensure black record displays on page load
        function ensureBlackRecordDisplay() {
          const recordDisc1 = document.getElementById("builder-record-display");
          if (recordDisc1) {
            const currentImage =
              window.getComputedStyle(recordDisc1).backgroundImage;
            // If no image is set or it's the default placeholder, set black record
            if (
              !currentImage ||
              currentImage === "none" ||
              currentImage === 'url("")' ||
              currentImage.includes("default_record_image")
            ) {
              recordDisc1.style.backgroundImage =
                "url(https://uploads-ssl.webflow.com/65ce69671190e385bf638294/66c35137e88fe82114818e60_Black_Record.png)";
              recordDisc1.style.backgroundSize = "contain";
              recordDisc1.style.backgroundRepeat = "no-repeat";
              recordDisc1.style.backgroundPosition = "center";
            }
          }
        }

        // Run on page load
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", () => {
            setTimeout(ensureBlackRecordDisplay, 200);
          });
        } else {
          setTimeout(ensureBlackRecordDisplay, 200);
        }

        // Also ensure after builder.js initializes
        window.addEventListener("load", () => {
          setTimeout(ensureBlackRecordDisplay, 800);
        });
      })();
    </script>
  </body>
</html>
